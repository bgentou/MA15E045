<!DOCTYPE html>
<html lang="fr-FR"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-a6e161b2431e1f94a14e0f5d32135a3c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/quarto-contrib/reveal-header-1.0.0/add_header.js" defer="true"></script>
<link href="../site_libs/quarto-contrib/reveal-header-1.0.0/add_header.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/grid-htext-1.0.0/grid_htext.css" rel="stylesheet">
<script src="../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="author" content="Équipe BD">
<meta name="dcterms.date" content="2025-10-03">
<title>MA15E045 - Automne 2025 – BD IV: SQL III</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
<link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
<link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
<style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #24292e;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #24292e; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #6a737d; } /* Annotation */
    code span.at { color: #d73a49; } /* Attribute */
    code span.bn { color: #005cc5; } /* BaseN */
    code span.bu { color: #d73a49; } /* BuiltIn */
    code span.cf { color: #d73a49; } /* ControlFlow */
    code span.ch { color: #032f62; } /* Char */
    code span.cn { color: #005cc5; } /* Constant */
    code span.co { color: #6a737d; } /* Comment */
    code span.cv { color: #6a737d; } /* CommentVar */
    code span.do { color: #6a737d; } /* Documentation */
    code span.dt { color: #d73a49; } /* DataType */
    code span.dv { color: #005cc5; } /* DecVal */
    code span.er { color: #ff5555; text-decoration: underline; } /* Error */
    code span.ex { color: #d73a49; font-weight: bold; } /* Extension */
    code span.fl { color: #005cc5; } /* Float */
    code span.fu { color: #6f42c1; } /* Function */
    code span.im { color: #032f62; } /* Import */
    code span.in { color: #6a737d; } /* Information */
    code span.kw { color: #d73a49; } /* Keyword */
    code span.op { color: #24292e; } /* Operator */
    code span.ot { color: #6f42c1; } /* Other */
    code span.pp { color: #d73a49; } /* Preprocessor */
    code span.re { color: #6a737d; } /* RegionMarker */
    code span.sc { color: #005cc5; } /* SpecialChar */
    code span.ss { color: #032f62; } /* SpecialString */
    code span.st { color: #032f62; } /* String */
    code span.va { color: #e36209; } /* Variable */
    code span.vs { color: #032f62; } /* VerbatimString */
    code span.wa { color: #ff5555; } /* Warning */
  </style>
<link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-fc22af260e9e2d20ec1df9e302aeb234.css">
<link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
<link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
<link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
<link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
<style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
<script>
  MathJax = {
    loader: {
      load: ['[tex]/boldsymbol']
    },
    tex: {
      tags: "all",
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      packages: {
        '[+]': ['boldsymbol']
      }
    }
  };
  </script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<meta property="og:title" content="BD IV: SQL III – MA15E045 - Automne 2025">
<meta property="og:description" content="Langage Manipulation de Données 3 : Aggrégation/Fenêtres/Partitions">
<meta property="og:site_name" content="MA15E045 - Automne 2025">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-color="#1c191c" class="quarto-title-block center"><h1 class="title">BD IV: SQL III</h1>
  <p class="subtitle">Langage Manipulation de Données 3 : Aggrégation/Fenêtres/Partitions</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Équipe BD 
</div>
        <p class="quarto-title-affiliation">
            <a href="https://u-paris.fr">LPSM Université Paris-Cité</a>
          </p>
    </div>
</div>

  <p class="date">2025-10-03</p>
</section><section id="TOC"><nav role="doc-toc"><h2 id="toc-title">Plan</h2>
<ul>
<li><a href="#/fonctions-dagr%C3%A9gation" id="/toc-fonctions-dagrégation">Fonctions d’agrégation</a></li>
<li><a href="#/partitions-group-by" id="/toc-partitions-group-by">Partitions, <code>GROUP BY</code></a></li>
<li><a href="#/s%C3%A9lection-sur-les-groupes-et-tri-des-r%C3%A9sultats" id="/toc-sélection-sur-les-groupes-et-tri-des-résultats">Sélection sur les groupes et tri des résultats</a></li>
<li><a href="#/fonctions-fen%C3%AAtres-window-functions" id="/toc-fonctions-fenêtres-window-functions">Fonctions fenêtres (Window functions)</a></li>
<li><a href="#/groupements-avanc%C3%A9s" id="/toc-groupements-avancés">Groupements avancés</a></li>
<li><a href="#/r%C3%A9sum%C3%A9" id="/toc-résumé">Résumé</a></li>
<li><a href="#/r%C3%A9f%C3%A9rences" id="/toc-références">Références</a></li>
<li><a href="#/fin" id="/toc-fin">Fin</a></li>
</ul></nav></section><section><section id="fonctions-dagrégation" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Fonctions d’agrégation</h1>

</section><section id="limite-de-lalgèbre-relationnelle-pure" class="slide level2 center"><h2>Limite de l’algèbre relationnelle pure</h2>
<p>L’algèbre relationnelle pure (σ, π, ⋈) ne sait pas tout calculer.</p>
<p>Certains problèmes aisément solubles par un langage de programmation complet (<code>Python</code>, <code>C</code>, <code>R</code>, …) ne sont pas solubles dans l’algèbre relationnelle pure :</p>
<ul>
<li><p>compter. Exemple simple : calculer le nombre de lignes d’une table.</p></li>
<li><p>dans une table décrivant une arborescence (une organisation hiérarchisée), déterminer tous les descendants d’un enregistrement.</p></li>
</ul></section><section id="fonctions-dagrégation-1" class="slide level2 center"><h2>Fonctions d’agrégation ?</h2>
<p>Possibilité de <em>compter</em>, de <em>faire des moyennes</em>, de trouver un maximum, … en SQL (contrairement à l’algèbre relationnelle “classique”).</p>
</section><section id="extension-possible-de-lalgèbre-relationnelle" class="slide level2 center"><h2>Extension possible de l’algèbre relationnelle</h2>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Idée</strong></p>
</div>
<div class="callout-content">
<p>Introduire un opérateur <span class="math inline">\(Résume()\)</span> qui admet comme arguments une table <span class="math inline">\(T\)</span> et une suite d’expressions susceptibles de calculer des <em>agrégats</em> : moyenne, somme, comptage, etc.</p>
<p>Proposition de syntaxe :</p>
<p><span class="math inline">\(Résume(T, expr_1, ..., expr_k)\)</span> retourne une table <span class="math inline">\(S\)</span> à <strong>une</strong> ligne et <span class="math inline">\(k\)</span> colonnes.</p>
<p>La colonne <span class="math inline">\(i\)</span> de <span class="math inline">\(S\)</span> contient l’évaluation de <span class="math inline">\(expr_i\)</span> sur la table <span class="math inline">\(T\)</span>.</p>
</div>
</div>
</div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Il n’est pas évident de définir ce que peut être une fonction d’agrégation et un agrégat.</p>
<p>Nous travaillerons à partir d’exemples.</p>
</div>
</div>
</div>
<!--
## Fonctions d'agrégation en SQL 


- [Documentation PostgreSQL](https://www.postgresql.org/docs/current/tutorial-agg.html){target="_blank"}


- [Analyse commerciale ou Buisiness Analytics](https://fr.wikipedia.org/wiki/Business_analytics){target="_blank"}, 

- OLAP
  
- Statistique et Data Science 
-->
</section><section id="fonctions-dagrégation-sum-et-avg" class="slide level2 center"><h2>Fonctions d’agrégation <code>SUM</code> et <code>AVG</code>
</h2>
<ul>
<li>Somme des valeurs prises par <code>nomattribut</code>
</li>
</ul>
<pre><code>Résume(T, SOMME(nomattribut))</code></pre>
<p>se traduit en</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb2-2"><a></a>  <span class="fu">SUM</span> ([<span class="kw">DISTINCT</span>|<span class="kw">ALL</span>] <span class="op">&lt;</span>nomattribut<span class="op">&gt;</span>)  </span>
<span id="cb2-3"><a></a><span class="kw">FROM</span> T</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="fragment">
<ul>
<li>Moyenne des valeurs prises par <code>nomattribut</code>
</li>
</ul>
<pre><code>Résume(T, MOYENNE(nomattribut))</code></pre>
<p>se traduit en</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb4-2"><a></a>  <span class="fu">AVG</span> ([<span class="kw">DISTINCT</span>|<span class="kw">ALL</span>] <span class="op">&lt;</span>nom_attribut<span class="op">&gt;</span>) </span>
<span id="cb4-3"><a></a><span class="kw">FROM</span> T</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Le type de l’attribut doit correspondre à un nombre (cf.&nbsp;spécifications de chaque fonction dans la documentation).</p>
</div>
</div>
</div>
</div>
</section><section id="options-all-et-distinct-des-fonctions-dagrégation" class="slide level2 center"><h2>Options <code>ALL</code> et <code>DISTINCT</code> des fonctions d’agrégation</h2>
<p>Ces options sont disponibles pour toutes les fonctions</p>
<p>mais sont surtout utiles pour <code>COUNT</code> :</p>
<ul>
<li><p><code>ALL</code>, option par défaut : toutes les valeurs de la colonne sont utilisées,</p></li>
<li><p><code>DISTINCT</code> : les valeurs doublons ne sont utilisées qu’une fois.</p></li>
</ul></section><section id="exemples-avec-sum-et-avg" class="slide level2 center"><h2>Exemples avec <code>SUM</code> et <code>AVG</code>
</h2>
<ul>
<li>Somme des populations des villes du pays de code <code>FRA</code> (dans le schéma <code>world</code>).</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a></a><span class="kw">SELECT</span> <span class="fu">SUM</span>(population)  </span>
<span id="cb5-2"><a></a><span class="kw">FROM</span> city </span>
<span id="cb5-3"><a></a><span class="kw">WHERE</span> countrycode <span class="op">=</span> <span class="st">'FRA'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Traduction de</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a></a>R1 <span class="op">=</span> σ(city, countrycode <span class="op">=</span> <span class="st">'FRA'</span>)</span>
<span id="cb6-2"><a></a>R <span class="op">=</span> Résume(R1, SOMME(population))</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="fragment">
<ul>
<li>Moyenne des populations des villes du continent <code>Europe</code> et <code>Afrique</code>.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(ci.population)  </span>
<span id="cb7-2"><a></a><span class="kw">FROM</span> city ci <span class="kw">join</span> country co <span class="kw">on</span> ci.countrycode <span class="op">=</span> co.countrycode</span>
<span id="cb7-3"><a></a><span class="kw">WHERE</span> co.continent <span class="kw">in</span> (<span class="st">'Afrique'</span>,<span class="st">'Europe'</span>);</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Traduction de</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a></a>R1 <span class="op">=</span> ⋈(city, country, city.countrycode <span class="op">=</span> country.countrycode)</span>
<span id="cb8-2"><a></a>R2 <span class="op">=</span> σ(R1, continent <span class="kw">in</span> (<span class="st">'Afrique'</span>,<span class="st">'Europe'</span>))</span>
<span id="cb8-3"><a></a>R <span class="op">=</span> Résume(R1, <span class="fu">avg</span>(population))</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</section><section id="fonctions-de-calcul-max-min" class="slide level2 center"><h2>Fonctions de calcul <code>MAX</code>, <code>MIN</code>
</h2>
<ul>
<li>maximum des valeurs prises par <code>&lt;nomattribut&gt;</code> dans <code>T</code> :</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb9-2"><a></a>  <span class="fu">MAX</span> (<span class="op">&lt;</span>nomattribut<span class="op">&gt;</span>)  </span>
<span id="cb9-3"><a></a><span class="kw">FROM</span> T ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="fragment">
<ul>
<li>minimum des valeurs prises par <code>&lt;nomattribut&gt;</code> dans <code>T</code> :</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb10-2"><a></a>  <span class="fu">MIN</span> (<span class="op">&lt;</span>nomattribut<span class="op">&gt;</span>)  </span>
<span id="cb10-3"><a></a><span class="kw">FROM</span> T </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="fragment">
<p>Exemple :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a></a><span class="kw">SELECT</span> <span class="fu">max</span>(gnp)   </span>
<span id="cb11-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb11-3"><a></a><span class="kw">WHERE</span> region <span class="op">=</span> <span class="st">'Caribbean'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="gestion-des-données-manquantes-null" class="slide level2 center"><h2>Gestion des données manquantes (<code>NULL</code>)</h2>
<ul>
<li><p>En statistique : données manquantes prises en compte dans les fonctions d’agrégation.</p></li>
<li>
<p>En SQL : données manquantes ignorées dans les fonctions d’agrégation,</p>
<p>à l’exception de <code>COUNT(*)</code>.</p>
</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a></a><span class="kw">SELECT</span> name_country, gnpold, gnp</span>
<span id="cb12-2"><a></a><span class="kw">FROM</span> country</span>
<span id="cb12-3"><a></a><span class="kw">WHERE</span> continent <span class="op">=</span> <span class="st">'Europe'</span> <span class="kw">AND</span> (gnp <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> gnpold <span class="kw">IS</span> <span class="kw">NULL</span>)</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Résultat : 10 lignes.</p>
</div>
<div class="fragment">
<p>Pourtant, ces données manquantes n’empèchent pas le calcul du maximum sur ces colonnes.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a></a><span class="kw">SELECT</span> <span class="fu">max</span>(gnpold) <span class="kw">AS</span> max_gnpold, <span class="fu">max</span>(gnp) <span class="kw">AS</span> max_gnp   </span>
<span id="cb13-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb13-3"><a></a><span class="kw">WHERE</span> continent  <span class="op">=</span> <span class="st">'Europe'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+-------------+------------+
|  max_gnpold |  max_gnp   |
+-------------+------------+
|  2102826.00 | 2133367.00 |
+-------------+------------+</code></pre>
</div>
</section><section id="fonction-dagrégation-sur-des-valeurs-toutes-null" class="slide level2 center"><h2>Fonction d’agrégation sur des valeurs toutes <code>NULL</code>
</h2>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Que se passe-t-il si, après une éventuelle sélection, toutes les valeurs de du calcul d’agrégat sont <code>NULL</code> ?</p>
<p>La valeur calculée est alors <code>NULL</code>, ce qui signifie “pas de valeur”.</p>
<p>Essayez <code>SELECT MIN(gnpold) FROM country WHERE gnpold IS NULL;</code> !</p>
</div>
</div>
</div>
</section><section id="fonction-dagrégation-sur-une-table-vide" class="slide level2 center"><h2>Fonction d’agrégation sur une table vide</h2>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Les fonctions d’agrégation renvoie un scalaire même sur une table vide.</p>
<p>Pour une table vide, la valeur calculée est <code>NULL</code>.</p>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb15-2"><a></a>  <span class="fu">SUM</span>(population) <span class="kw">AS</span> urban_pop</span>
<span id="cb15-3"><a></a><span class="kw">FROM</span> city  ci</span>
<span id="cb15-4"><a></a><span class="kw">WHERE</span> ci.countrycode <span class="op">=</span> <span class="st">'zzz'</span> ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="fragment">
<pre><code>+-----------+
| urban_pop |
|-----------|
| &lt;null&gt;    |
+-----------+</code></pre>
<p>Est-ce cohérent?</p>
<p>Le résultat signifie : “Pour le pays de code ‘zzz’, pas de données”</p>
</div>
</section><section id="fonctions-de-calcul-count" class="slide level2 center"><h2>Fonctions de calcul : <code>COUNT</code>
</h2>
<p>On peut aussi compter le nombre de tuples d’une table :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb17-2"><a></a>  <span class="fu">COUNT</span>(<span class="op">*</span> |[<span class="kw">ALL</span> | <span class="kw">DISTINCT</span>] <span class="op">&lt;</span>nomattribut<span class="op">&gt;</span>)  </span>
<span id="cb17-3"><a></a><span class="kw">FROM</span> T</span>
<span id="cb17-4"><a></a><span class="co">-- | pour indiquer une alternative, [ ] pour une option.</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Options de la fonction <code>COUNT</code> :</p>
<ul>
<li>
<code>*</code> : compte le nombre de lignes dans la table ou la sous-requête, <strong>en incluant les valeurs <code>NULL</code></strong>.</li>
<li>
<code>DISTINCT</code> : sans les doublons et sans les valeurs <code>NULL</code>,</li>
<li>
<code>ALL</code> : avec les doublons mais sans les valeurs <code>NULL</code>,</li>
</ul>
<p>Si la table est vide, <code>COUNT</code> renvoie 0.</p>
</div>
</div>
</div>
<div class="fragment">
<p>Nombre de pays dans la région <code>Carribean</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>)  </span>
<span id="cb18-2"><a></a><span class="kw">FROM</span> country</span>
<span id="cb18-3"><a></a><span class="kw">WHERE</span> region <span class="op">=</span> <span class="st">'Caribbean'</span>; </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="exemples-dutilisation-des-options-de-la-fonction-count" class="slide level2 center"><h2>Exemples d’utilisation des options de la fonction <code>COUNT</code>
</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> country;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>retourne <code>239</code>, le nombre de lignes de la table <code>country</code>.</p>
<div class="fragment">
<p>&nbsp;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span> (indepyear) <span class="kw">FROM</span> country;</span>
<span id="cb20-2"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span> (<span class="kw">ALL</span> indepyear) <span class="kw">FROM</span> country;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>retournent <code>192</code>, le nombre de valeurs non <code>NULL</code> de la colonne <code>indepyear</code>.</p>
</div>
<div class="fragment">
<p>&nbsp;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span> (<span class="kw">DISTINCT</span> indepyear) <span class="kw">FROM</span> country;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>retourne <code>88</code>, le nombre de valeurs disctintes et non <code>NULL</code> de la colonne <code>indepyear</code>.</p>
</div>
<div class="fragment">
<p>&nbsp;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> (<span class="kw">SELECT</span> indepyear <span class="kw">FROM</span> country) <span class="kw">as</span> T;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>retourne <code>239</code> car <code>T</code> contient une seule colonne avec <code>239</code> lignes, les 47 lignes <code>NULL</code> sont comptées comme les autres.</p>
</div>
</section><section id="opérations-sur-des-fonctions-dagrégation" class="slide level2 center"><h2>Opérations sur des fonctions d’agrégation</h2>
<p>PNB moyen par habitant du continent <code>South America</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb23-2"><a></a>  <span class="fu">ROUND</span>(<span class="fu">SUM</span>(<span class="fl">1e6</span><span class="op">*</span>gnp)<span class="op">/</span><span class="fu">SUM</span>(population_country),<span class="dv">2</span>) <span class="kw">as</span> pnb_avg</span>
<span id="cb23-3"><a></a><span class="kw">FROM</span> </span>
<span id="cb23-4"><a></a>  country </span>
<span id="cb23-5"><a></a><span class="kw">WHERE</span> </span>
<span id="cb23-6"><a></a>  continent <span class="op">=</span> <span class="st">'South America'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Résultat : <code>4372,36</code></p>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p><span class="math inline">\(10^6\)</span> s’écrit <code>1e6</code>. On a écrit <code>1e6*gnp</code> car <code>gnp</code> est exprimé en millions de USD.</p>
<p><code>ROUND(x,s)</code> effectue un arrondi de x avec s chiffres après la virgule. <code>s</code> négatif accepté.</p>
<p><a href="https://docs.postgresql.fr/current/functions-math.html" target="_blank">Documentation des fonctions mathématiques</a></p>
</div>
</div>
</div>
</section><section id="fonctions-dagrégation-sur-des-opérations" class="slide level2 center"><h2>Fonctions d’agrégation sur des opérations</h2>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Les fonctions d’agrégation peuvent s’appliquer à des opérations arithmétiques entre les différents attributs d’un même tuple…</p>
</div>
</div>
</div>
<div class="fragment">
<p>Moyenne des PNB/habitant des pays du continent ‘South America’. A ne pas confondre avec la requête précédente !</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb24-2"><a></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(<span class="fl">1e6</span><span class="op">*</span>gnp<span class="op">/</span>population_country),<span class="dv">2</span>) <span class="kw">as</span> pnb_country_avg</span>
<span id="cb24-3"><a></a><span class="kw">FROM</span> country </span>
<span id="cb24-4"><a></a><span class="kw">WHERE</span> </span>
<span id="cb24-5"><a></a>  continent <span class="op">=</span> <span class="st">'South America'</span> <span class="kw">AND</span> population_country <span class="op">&gt;</span> <span class="dv">0</span> ;</span>
<span id="cb24-6"><a></a><span class="co">-- Le test population_country &gt; 0 évite les divisions par 0</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Résultat : <code>3176,44</code></p>
<!--
# Retour sur fonction `SUM` {background-color="#1c191c"}


## Fonction de calcul `SUM()`

On peut sommer les valeurs contenues dans une colonne numérique 


::: {.cell}

```{.sql .cell-code}
SELECT 
  SUM(population) AS urban_pop
FROM city  ci
WHERE ci.countrycode = 'GBR' ;
```
:::


```{.sql}
+-----------+
| urban_pop |
|-----------|
| 22436673  |
+-----------+
```

## Sommation sur tableau vide



::: {.cell}

```{.sql .cell-code}
SELECT 
  SUM(population) AS urban_pop
FROM city  ci
WHERE ci.countrycode = 'zzz' ;
+-----------+
| urban_pop |
|-----------|
| <null>    |
+-----------+
```
:::


Est-ce cohérent?
-->
</div>
</section><section id="utilisation-de-case-when-...then-...-else-...-end" class="slide level2 center"><h2>Utilisation de <code>CASE WHEN ...THEN ... [ELSE ...] END</code>
</h2>
<p>Dans une fonction d’agrégation, une expression <code>CASE WHEN</code> teste des conditions sur le tuple courant et renvoie la valeur correspondant à la première condition vraie.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a></a><span class="cf">CASE</span></span>
<span id="cb25-2"><a></a>    <span class="cf">WHEN</span> condition1 <span class="cf">THEN</span> result1</span>
<span id="cb25-3"><a></a>    [<span class="cf">WHEN</span> condition2 <span class="cf">THEN</span> result2]</span>
<span id="cb25-4"><a></a>    [<span class="cf">WHEN</span> conditionN <span class="cf">THEN</span> resultN]</span>
<span id="cb25-5"><a></a>    [<span class="cf">ELSE</span> result]</span>
<span id="cb25-6"><a></a><span class="cf">END</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Si aucune condition n’est vraie et qu’il n’y pas de clause <code>ELSE</code>, <code>CASE</code> retourne <code>NULL</code>.</p>
</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb26-2"><a></a>  <span class="fu">SUM</span>(</span>
<span id="cb26-3"><a></a>    <span class="cf">CASE</span> </span>
<span id="cb26-4"><a></a>      <span class="cf">WHEN</span> countrycode<span class="op">=</span><span class="st">'GBR'</span> <span class="cf">THEN</span> population </span>
<span id="cb26-5"><a></a>    <span class="cf">END</span>) <span class="kw">AS</span> urban_pop </span>
<span id="cb26-6"><a></a> <span class="kw">FROM</span> city ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+-----------+
| urban_pop |
|-----------|
| 22436673  |
+-----------+</code></pre>
</section><section id="gestion-des-valeurs-manquantes-avec-case-when-...then-...-else-...-end" class="slide level2 center"><h2>Gestion des valeurs manquantes avec <code>CASE WHEN ...THEN ... [ELSE ...] END</code>
</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb28-2"><a></a>  <span class="fu">AVG</span>(</span>
<span id="cb28-3"><a></a>    <span class="cf">CASE</span> </span>
<span id="cb28-4"><a></a>      <span class="cf">WHEN</span> gnpold <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span> gnpold </span>
<span id="cb28-5"><a></a>      <span class="cf">ELSE</span> <span class="dv">0</span> </span>
<span id="cb28-6"><a></a>    <span class="cf">END</span>):<span class="ch">:NUMERIC</span>(<span class="dv">8</span>,<span class="dv">2</span>) <span class="kw">AS</span> avg_gnpold </span>
<span id="cb28-7"><a></a> <span class="kw">FROM</span> world.country </span>
<span id="cb28-8"><a></a> <span class="kw">WHERE</span> continent <span class="op">=</span> <span class="st">'Europe'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Retourne <code>203956,54</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb29-2"><a></a>  <span class="fu">AVG</span>(gnpold):<span class="ch">:NUMERIC</span>(<span class="dv">8</span>,<span class="dv">2</span>) <span class="kw">AS</span> avg_gnpold </span>
<span id="cb29-3"><a></a> <span class="kw">FROM</span> world.country </span>
<span id="cb29-4"><a></a> <span class="kw">WHERE</span> continent <span class="op">=</span> <span class="st">'Europe'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>Retourne <code>260611,14</code></p>
</section><section id="autres-possibilités-avec-case-when-...then-...-else-...-end" class="slide level2 center"><h2>Autres possibilités avec <code>CASE WHEN ...THEN ... [ELSE ...] END</code>
</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb30-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb30-2"><a></a>  <span class="fu">SUM</span>(<span class="cf">CASE</span> </span>
<span id="cb30-3"><a></a>    <span class="cf">WHEN</span> governmentform <span class="kw">LIKE</span> <span class="st">'%Monarchy%'</span> <span class="cf">THEN</span> population_COUNTRY </span>
<span id="cb30-4"><a></a>    <span class="cf">ELSE</span> <span class="dv">0</span>    <span class="co">-- résultat identique si on enlève cette ligne</span></span>
<span id="cb30-5"><a></a>  <span class="cf">END</span>) <span class="kw">AS</span> pop_monarch,  </span>
<span id="cb30-6"><a></a>  <span class="fu">SUM</span>(<span class="cf">CASE</span> </span>
<span id="cb30-7"><a></a>    <span class="cf">WHEN</span> governmentform <span class="kw">LIKE</span> <span class="st">'%Republic%'</span> <span class="cf">THEN</span> population_COUNTRY </span>
<span id="cb30-8"><a></a>    <span class="cf">ELSE</span> <span class="dv">0</span>   <span class="co">-- résultat identique si on enlève cette ligne</span></span>
<span id="cb30-9"><a></a>  <span class="cf">END</span>) <span class="kw">AS</span> pop_repu </span>
<span id="cb30-10"><a></a><span class="kw">FROM</span> country ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+-------------+------------+
| pop_monarch | pop_repu   |
|-------------+------------|
| 519485000   | 5502453700 |
+-------------+------------+</code></pre>
</section><section id="agrégats-sur-des-données-filtrées-filter-where-condition" class="slide level2 center"><h2>Agrégats sur des données filtrées <code>FILTER (WHERE condition)</code>
</h2>
<p>Avec une clause <code>FILTER</code>, la fonction d’agrégation n’utilise que les tuples vérifiant la condition.</p>
<div class="columns">
<div class="column" style="width:70%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb32-2"><a></a>  <span class="fu">SUM</span>(population_country) <span class="kw">FILTER</span>  </span>
<span id="cb32-3"><a></a>    (<span class="kw">WHERE</span> governmentform <span class="kw">LIKE</span> <span class="st">'%Monarchy%'</span>) <span class="kw">AS</span> pop_monarch,  </span>
<span id="cb32-4"><a></a>  <span class="fu">SUM</span>(population_country) <span class="kw">FILTER</span> </span>
<span id="cb32-5"><a></a>    (<span class="kw">WHERE</span> governmentform <span class="kw">LIKE</span> <span class="st">'%Republic%'</span>) <span class="kw">AS</span> pop_repu </span>
<span id="cb32-6"><a></a><span class="kw">FROM</span> country ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:30%;">
<pre><code>+-------------+------------+
| pop_monarch | pop_repu   |
|-------------+------------|
| 519485000   | 5502453700 |
+-------------+------------+</code></pre>
</div></div>
<div class="fragment">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>Il est plus conforme à l’algèbre relationnelle et au SQL d’organiser les données en lignes.</p>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:70%;">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb34-1"><a></a><span class="kw">SELECT</span> <span class="st">'Monarchy'</span> <span class="kw">as</span> governmentform, <span class="fu">SUM</span>(population_country) <span class="kw">as</span> population    </span>
<span id="cb34-2"><a></a><span class="kw">FROM</span> world.country c</span>
<span id="cb34-3"><a></a><span class="kw">WHERE</span> c.governmentform <span class="kw">LIKE</span> <span class="st">'%Monarchy%'</span></span>
<span id="cb34-4"><a></a><span class="kw">UNION</span></span>
<span id="cb34-5"><a></a><span class="kw">SELECT</span> <span class="st">'Republic'</span> <span class="kw">as</span> governmentform, <span class="fu">SUM</span>(population_country) <span class="kw">as</span> population    </span>
<span id="cb34-6"><a></a><span class="kw">FROM</span> world.country c</span>
<span id="cb34-7"><a></a><span class="kw">WHERE</span> c.governmentform <span class="kw">LIKE</span> <span class="st">'%Republic%'</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:30%;">
<pre><code>+----------------+------------+
| governmentform | population |
|----------------+------------|
| Monarchy       |  519485000 |
|----------------+------------|
| Republic       | 5502453700 |
+----------------+------------+</code></pre>
</div></div>
</div>
</section><section id="problèmes-defficacité" class="slide level2 center"><h2>Problèmes d’efficacité</h2>
<p>Nom des régions comportant plus de <span class="math inline">\(15\)</span> pays.</p>
<div class="fragment">
<p>La requête suivante est à éviter :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb36-1"><a></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> c.region </span>
<span id="cb36-2"><a></a><span class="kw">FROM</span> country c </span>
<span id="cb36-3"><a></a><span class="kw">WHERE</span> (</span>
<span id="cb36-4"><a></a>  <span class="kw">SELECT</span> <span class="fu">COUNT</span> (<span class="op">*</span>)     </span>
<span id="cb36-5"><a></a>  <span class="kw">FROM</span> country co     </span>
<span id="cb36-6"><a></a>  <span class="kw">WHERE</span> co.region <span class="op">=</span> c.region</span>
<span id="cb36-7"><a></a>) <span class="op">&gt;=</span> <span class="dv">15</span></span>
<span id="cb36-8"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> c.region;  </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p>5 lignes.</p>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>Y-a-t-il des calculs effectués plusieurs fois sur les mêmes données ?</p>
</div>
</div>
</div>
<!--
## Problème d'efficacité

Trouver les régions où au moins un pays possède une espérance de vie inférieure à 50 ans.

```{.sql}
SELECT DISTINCT continent, region
FROM country c 
WHERE (
  SELECT MIN(d.lifeexpectancy)     
  FROM country d    
  WHERE c.region=d.region
  ) < 50    
ORDER BY continent, region;
```

|**Continent**    |**Region**                   |
|:------------|:------------------------|
|Africa       |Central Africa           |
|Africa       |Eastern Africa           |
|Africa       |Northern Africa          |
|Africa       |Southern Africa          |
|Africa       |Western Africa           |
|Asia         |Southeast Asia           |
|Asia         |Southern and Central Asia|
|North America|Caribbean                |


::: {.callout-note}

Pourquoi cette requête est-elle horrible ?

:::
-->
</div>
</section><section id="efficacité" class="slide level2 center"><h2>Efficacité</h2>
<p><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i> On peut faire plus efficace, gràce à la suite du cours :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb37-1"><a></a><span class="kw">SELECT</span> region    </span>
<span id="cb37-2"><a></a><span class="kw">FROM</span> country     </span>
<span id="cb37-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> region</span>
<span id="cb37-4"><a></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;=</span> <span class="dv">15</span></span>
<span id="cb37-5"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> region;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<!--

---

Mais si on veut lister les régions où tous les pays ont une espèrance de  vie supérieure à 50 ?

. . .

Pourquoi pas ?

```{.sql}
SELECT 
  DISTINCT continent, region
FROM country c 
WHERE (
  SELECT MIN(d.lifeexpectancy)     
  FROM country d    
  WHERE c.region=d.region
  ) > 50    
ORDER BY continent, region;
```

::: {.callout-caution}

Combien de fois calculez vous l'espérance de minimale pour chaque région ?

:::
-->
</section><section id="pour-en-savoir-plus" class="slide level2 center"><h2>Pour en savoir plus ?</h2>
<p><a href="https://www.postgresql.org/docs/current/functions-aggregate.html" target="_blank">Documentation PostgreSQL</a></p>
</section></section><section><section id="partitions-group-by" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Partitions, <code>GROUP BY</code>
</h1>

</section><section id="partition-de-résultats-de-requêtes" class="slide level2 center"><h2>Partition de résultats de requêtes</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb38-1"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="op">&lt;</span>nomattribut1<span class="op">&gt;</span>, <span class="op">..</span>., <span class="op">&lt;</span>nomattributn<span class="op">&gt;</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><p><code>GROUP BY</code> permet de regrouper l’ensemble des résultats d’une requête selon la valeur de certains attributs,</p></li>
<li><p>Forme des sous-relations auxquelles on peut appliquer des fonctions d’agrégation (<code>SUM</code>, <code>MAX</code>, …) renvoyant un résultat par sous-relation.</p></li>
</ul>
<div class="fragment">
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p><strong>Gestion des valeurs manquantes</strong> : les valeurs <code>NULL</code>d’un attribut forment un groupe dans la partition selon celui-ci.</p>
</div>
</div>
</div>
</div>
</section><section id="utilisation-group-by" class="slide level2 center"><h2>Utilisation <code>GROUP BY</code>
</h2>
<p>Calculer la population de chaque continent.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb39-1"><a></a><span class="kw">SELECT</span> continent, <span class="fu">SUM</span>(population_country) <span class="kw">as</span> population_continent</span>
<span id="cb39-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb39-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> continent;    </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+--------------+----------------------+
| continent    | population_continent |
+--------------+----------------------+
|Asia          |          3705025700  |
|South America |           345780000  |
|North America |           482993000  |
|Oceania       |            30401150  |
|Antarctica    |                   0  |
|Africa        |           784475000  |
|Europe        |           730074600  |
+--------------+----------------------+
</code></pre>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>On peut afficher <code>continent</code> pour chaque groupe parce qu’on a groupé selon cet attribut</p>
</div>
</div>
</div>
</section><section id="exemple-avec-group-by" class="slide level2 center"><h2>Exemple avec <code>GROUP BY</code>
</h2>
<p>Quel est le <code>gnp</code> moyen, le <code>gnp</code> maximum et le <code>gnp</code> minimum par <code>region</code> sur le continent <code>Europe</code> en milliers de USD par habitant ?</p>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb41-1"><a></a><span class="kw">SELECT</span> region, </span>
<span id="cb41-2"><a></a>     <span class="fu">ROUND</span>(<span class="dv">1000</span> <span class="op">*</span> <span class="fu">SUM</span>(gnp)<span class="op">/</span><span class="fu">SUM</span>(population_country),<span class="dv">2</span>) <span class="kw">AS</span> avg_gnp,  </span>
<span id="cb41-3"><a></a>     <span class="fu">ROUND</span>(<span class="fu">MAX</span>(<span class="dv">1000</span><span class="op">*</span> gnp<span class="op">/</span>population_country),<span class="dv">2</span>) <span class="kw">AS</span> max_gnp, </span>
<span id="cb41-4"><a></a>     <span class="fu">ROUND</span>(<span class="fu">MIN</span>(<span class="dv">1000</span><span class="op">*</span> gnp<span class="op">/</span>population_country),<span class="dv">2</span>) <span class="kw">AS</span> min_gnp,</span>
<span id="cb41-5"><a></a><span class="kw">FROM</span> country </span>
<span id="cb41-6"><a></a><span class="kw">WHERE</span> continent <span class="op">=</span> <span class="st">'Europe'</span> </span>
<span id="cb41-7"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> region </span>
<span id="cb41-8"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> avg_gnp <span class="kw">DESC</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+----------------+---------+---------+---------+
| region         | avg_gnp | max_gnp | min_gnp |
+----------------+---------+---------+---------+
|Nordic Countries|   28.00 |   32.66 |    0.00 |
|Western Europe  |   25.50 |   37.46 |   22.82 | 
|British Islands |   22.94 |   23.12 |   20.11 | 
|Southern Europe |   13.91 |   20.90 |    0.72 | 
|Baltic Countries|    2.96 |    3.70 |    2.64 |
|Eastern Europe  |    2.15 |    5.35 |    0.36 |
+----------------+---------+---------+---------+</code></pre>
</div>
</section><section id="précautions-avec-group-by" class="slide level2 center"><h2>Précautions avec <code>GROUP BY</code>
</h2>
<p>Pour chaque région, indiquer le continent, la région et la population du pays le plus peuplé.</p>
<p>La requête suivante n’est pas correcte</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb43-1"><a></a><span class="kw">SELECT</span> continent, region, <span class="fu">MAX</span>(population_country) </span>
<span id="cb43-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb43-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> region;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="fragment">
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>Les attributs présents dans le <code>SELECT</code> doivent impérativement être présents dans le <code>GROUP BY</code> pour s’assurer qu’ils sont communs à tous les tuples de chaque groupe.</p>
</div>
</div>
</div>
</div>
</section><section id="comment-afficher-un-attribut-absent-de-group-by" class="slide level2 center"><h2>Comment afficher un attribut absent de <code>GROUP BY</code> ?</h2>
<p>Pour chaque continent, indiquer le nom et la population du (des) pays le(s) plus peuplé(s).</p>
<div class="fragment">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>On ne peut pas utiliser une seule requête puisqu’on veut afficher les pays sans grouper selon les pays. Il faut donc faire les calculs d’agrégats dans une sous-requête.</p>
<p>Préférez les CTEs (ou éventuellement les requêtes imbriquées dans <code>FROM</code>), plus efficaces que les requêtes imbriquées dans <code>WHERE</code> qui sont ré-exécutées inutilement.</p>
</div>
</div>
</div>
</div>
</section><section id="solution" class="slide level2 center"><h2>Solution</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb44-1"><a></a><span class="kw">WITH</span> pmc <span class="kw">AS</span></span>
<span id="cb44-2"><a></a>  (<span class="kw">SELECT</span> continent, <span class="fu">MAX</span>(population_country) <span class="kw">AS</span> pop_max</span>
<span id="cb44-3"><a></a>  <span class="kw">FROM</span> country</span>
<span id="cb44-4"><a></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> continent)</span>
<span id="cb44-5"><a></a><span class="kw">SELECT</span> c.continent, c.name_country <span class="kw">AS</span> country_max_pop, c.population_country <span class="kw">AS</span> population</span>
<span id="cb44-6"><a></a><span class="kw">FROM</span> country c <span class="kw">JOIN</span> pmc <span class="kw">ON</span> c.continent <span class="op">=</span> pmc.continent</span>
<span id="cb44-7"><a></a><span class="kw">WHERE</span> c.population_country <span class="op">=</span> pmc.pop_max</span>
<span id="cb44-8"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> pmc.pop_max <span class="kw">DESC</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>+---------------+----------------------------------------------+------------+
| continent     | country_max_pop                              | population |
+---------------+----------------------------------------------+------------+
| Asia          | China                                        | 1277558000 |
| North America | United States                                |  278357000 |
| South America | Brazil                                       |  170115000 |
| Europe        | Russian Federation                           |  146934000 |
| Africa        | Nigeria                                      |  111506000 |
| Oceania       | Australia                                    |   18886000 |
| Antarctica    | Antarctica                                   |          0 |
| Antarctica    | Bouvet Island                                |          0 |
| Antarctica    | South Georgia and the South Sandwich Islands |          0 |
| Antarctica    | Heard Island and McDonald Islands            |          0 |
| Antarctica    | French Southern territories                  |          0 |
+---------------+----------------------------------------------+------------+</code></pre>
</section><section id="sous-partitionnements" class="slide level2 center"><h2>Sous-partitionnements</h2>
<p>Que fait cette requête ?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb46-1"><a></a><span class="kw">WITH</span> </span>
<span id="cb46-2"><a></a>  co_urb_rate <span class="kw">AS</span></span>
<span id="cb46-3"><a></a>  (</span>
<span id="cb46-4"><a></a>    <span class="kw">SELECT</span> co.countrycode, co.name_country, co.continent, <span class="fu">SUM</span>(ci.population)<span class="op">/</span>(co.population_country:<span class="ch">:numeric</span>) <span class="kw">AS</span> urb_rate</span>
<span id="cb46-5"><a></a>    <span class="kw">FROM</span> world.country co <span class="kw">JOIN</span> world.city ci <span class="kw">ON</span> co.countrycode <span class="op">=</span> ci.countrycode</span>
<span id="cb46-6"><a></a>    <span class="kw">WHERE</span> co.population_country <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb46-7"><a></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> co.countrycode, co.name_country, co.continent</span>
<span id="cb46-8"><a></a>  ),</span>
<span id="cb46-9"><a></a>  cont_max_ur <span class="kw">AS</span> </span>
<span id="cb46-10"><a></a>  (</span>
<span id="cb46-11"><a></a>    <span class="kw">SELECT</span> continent, <span class="fu">MAX</span>(urb_rate) <span class="kw">AS</span> max_ur</span>
<span id="cb46-12"><a></a>    <span class="kw">FROM</span> co_urb_rate</span>
<span id="cb46-13"><a></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> continent</span>
<span id="cb46-14"><a></a>  )</span>
<span id="cb46-15"><a></a><span class="kw">SELECT</span> </span>
<span id="cb46-16"><a></a>  co.continent, </span>
<span id="cb46-17"><a></a>  co.name_country, </span>
<span id="cb46-18"><a></a>  <span class="fu">round</span>(co.urb_rate,<span class="dv">2</span>)</span>
<span id="cb46-19"><a></a><span class="kw">FROM</span> co_urb_rate co <span class="kw">JOIN</span> cont_max_ur ct <span class="kw">ON</span> co.urb_rate <span class="op">=</span> ct.max_ur;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section><section class="slide level2 center"><p>Pour chaque continent, elle donne le pays le plus urbanisé avec son taux de population urbaine.</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>La conversion du diviseur avec <code>::numeric</code> est importante sinon le résultat est un entier (ici 0 ou 1) car la division entre entiers donne un entier par division euclidienne.</p>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Singapore, Gibraltar et les Cocos Islands ont un taux d’urbanisation supérieur à 1 !</p>
<p>Hypothèse : les origines des statistisques de population sur les villes et les pays ne sont pas les mêmes et les critères utilisés sont différents.</p>
</div>
</div>
</div>
</section><section id="aller-plus-loin-que-group-by" class="slide level2 center"><h2>Aller plus loin que <code>GROUP BY</code> ?</h2>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>L’opération <code>GROUP BY</code> ne renvoie pas une table mais (implicitement) <em>une collection de sous-tables</em> indicées/étiquetées par les valeurs des attributs de groupement.</p>
<p>L’opération <code>GROUP BY</code> ne peut pas s’intégrer dans une algèbre relationnelle, même étendue.</p>
</div>
</div>
</div>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>SQL n’offre pas de moyen d’utiliser le partitionnement effectué par <code>GROUP BY</code> autrement que pour effectuer des calculs d’agrégats et/ou une projection sur les attributs de groupement.</p>
</div>
</div>
</div>
<p>Cette requête n’est pas valide :</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb47-1"><a></a><span class="kw">SELECT</span> <span class="op">*</span>  </span>
<span id="cb47-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb47-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> continent ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Cette requête est valide :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb48-1"><a></a><span class="kw">SELECT</span> continent  </span>
<span id="cb48-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb48-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> continent ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section></section><section><section id="sélection-sur-les-groupes-et-tri-des-résultats" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Sélection sur les groupes et tri des résultats</h1>

</section><section id="sélection-sur-les-groupes-having" class="slide level2 center"><h2>Sélection sur les groupes <code>HAVING</code>
</h2>
<ul>
<li><p>La clause <code>HAVING</code> permet de poser une condition portant sur chacune des sous-relations générées par le <code>GROUP BY</code>,</p></li>
<li><p>Les sous-relations ne vérifiant pas la condition sont écartées du résultat.</p></li>
</ul>
<p>Liste des continents comportant au moins cinq régions.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb49-1"><a></a><span class="kw">SELECT</span> continent </span>
<span id="cb49-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb49-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> continent    </span>
<span id="cb49-4"><a></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> region) <span class="op">&gt;=</span> <span class="dv">5</span>;  </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section><section id="tri-de-résultats-order-by" class="slide level2 center"><h2>Tri de résultats <code>ORDER BY</code>
</h2>
<p>La clause <code>ORDER BY</code> permet de trier le résultat de la requête, en fournissant la liste des attributs sur lesquels effectuer le tri et en spécifiant le sens du tri pour chacun d’eux (<code>ASC</code> ou <code>DESC</code>).</p>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>L’ordre par défaut est <code>ASC</code>.</p>
</div>
</div>
</div>
<p>Liste des pays triés par ordre décroissant de population</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb50-1"><a></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb50-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb50-3"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> population_country <span class="kw">DESC</span>;  </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Que se passe-t-il avec les valeurs nulles ?</p>
<p>Le comportement dépend du serveur. PostgreSQL et Oracle les classent comme plus grandes que toutes les autres. SQL Server (Microsoft), MySQL, SQLite font l’inverse.</p>
</div>
</div>
</div>
</section><section id="ordre-des-opérations-where-group-by-having-order-by" class="slide level2 center scrollable"><h2>Ordre des opérations <code>WHERE</code>, <code>GROUP BY</code>, <code>HAVING</code>, <code>ORDER BY</code>
</h2>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>la sélection des tuples (<code>WHERE</code>),</li>
<li>puis le partitionnement (<code>GROUP BY</code>),</li>
<li>puis la sélection sur les groupes (<code>HAVING</code>),</li>
<li>enfin le tri des résultats (<code>ORDER BY</code>) .</li>
</ol>
</div>
</div>
</div>
<p>Que fait cette requête ?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb51-1"><a></a><span class="kw">SELECT</span> continent, <span class="fu">COUNT</span>(<span class="op">*</span>) </span>
<span id="cb51-2"><a></a><span class="kw">FROM</span> country </span>
<span id="cb51-3"><a></a><span class="kw">WHERE</span> countrycode <span class="kw">IN</span> (</span>
<span id="cb51-4"><a></a>  <span class="kw">SELECT</span> countrycode </span>
<span id="cb51-5"><a></a>  <span class="kw">FROM</span> countrylanguage </span>
<span id="cb51-6"><a></a>  <span class="kw">WHERE</span> language<span class="op">=</span><span class="st">'English'</span> <span class="kw">AND</span> percentage <span class="op">&gt;</span> <span class="dv">10</span> </span>
<span id="cb51-7"><a></a>) </span>
<span id="cb51-8"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> continent </span>
<span id="cb51-9"><a></a><span class="kw">HAVING</span> <span class="fu">AVG</span>(<span class="fl">1e6</span><span class="op">*</span>gnpold<span class="op">/</span>population_country) <span class="op">&gt;=</span> <span class="dv">1000</span> </span>
<span id="cb51-10"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> continent;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section></section><section><section id="fonctions-fenêtres-window-functions" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Fonctions fenêtres (Window functions)</h1>

</section><section id="principe-des-fonctions-fenêtres" class="slide level2 center"><h2>Principe des fonctions fenêtres</h2>
<p>Une <strong>fonction fenêtre</strong> effectue une partition puis un calcul sur le groupe de lignes (“une fenêtre”) auquel la ligne courante appartient.</p>
<p><a href="https://www.postgresql.org/docs/current/tutorial-window.html" target="_blank">Documentation PostgreSQL</a></p>
<div class="fragment">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>C’est comparable au type de calcul effectué avec une fonction d’agrégation.</p>
</div>
</div>
</div>
</div>
<div class="fragment">
<p>Mais les fonctions de fenêtre permettent de faire des calculs différents de ceux réalisés avec <code>GROUP BY</code>.</p>
<ul>
<li><p>Avec <code>GROUP BY</code>, le résultat rassemble les lignes d’un même groupe en une seule.</p></li>
<li><p>Avec les <em>fonctions fenêtres</em>, chaque ligne de la table reste présente dans le résultat.</p></li>
</ul>
<!--En coulisses, la fonction de fenêtre est capable d'accéder à plus que la ligne actuelle du résultat de la requête.-->
</div>
</section><section id="fonctions-fenêtres" class="slide level2 center"><h2>Fonctions fenêtres</h2>
<p>Soit <code>f</code> est une fonction d’agrégation (<code>SUM</code>, <code>AVG</code>, <code>MAX</code>, <code>MIN</code>, <code>COUNT</code>, etc.)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb52-1"><a></a>f(<span class="op">..</span>.) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> attribut),  </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>effectue le calcul sur le groupe de lignes auquel appartient la ligne courante après un partitionnement selon <code>attribut</code> (la “fenêtre” de la ligne courante).</p>
</section><section id="exemple-de-fonctions-fenêtres" class="slide level2 center"><h2>Exemple de fonctions fenêtres</h2>
<p>Présenter pour chaque pays dont la région comprend le motif <code>Countries</code>, l’espérance de vie du pays et les espérance de vie maximale et minimale des pays de la région.</p>
<div class="fragment">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb53-1"><a></a><span class="kw">SELECT</span> region, name_country, lifeexpectancy, </span>
<span id="cb53-2"><a></a>     <span class="fu">min</span>(lifeexpectancy) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> region),  </span>
<span id="cb53-3"><a></a>     <span class="fu">max</span>(lifeexpectancy) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> region)   </span>
<span id="cb53-4"><a></a><span class="kw">FROM</span> country </span>
<span id="cb53-5"><a></a><span class="kw">WHERE</span> region <span class="kw">LIKE</span> <span class="st">'%Countries'</span></span>
<span id="cb53-6"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> region, lifeexpectancy  </span>
<span id="cb53-7"><a></a><span class="kw">LIMIT</span> <span class="dv">6</span> ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<pre><code>+------------------+-----------------+---------------+-----+-----+
| Region           | Name of country |Life expectancy| min | max |
+------------------+-----------------+---------------+-----+-----+
| Baltic Countries | Latvia          |          68.4 | 68.4| 69.5|
| Baltic Countries | Lithuania       |          69.1 | 68.4| 69.5|
| Baltic Countries | Estonia         |          69.5 | 68.4| 69.5|
| Nordic Countries | Denmark         |          76.5 | 76.5| 79.6|
| Nordic Countries | Finland         |          77.4 | 76.5| 79.6|
| Nordic Countries | Faroe Islands   |          78.4 | 76.5| 79.6|
+------------------+-----------------+---------------+-----+-----+</code></pre>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Avec des fonctions d’agrégation sur un partitionnement par <code>GROUP BY region</code>, il n’était pas possible d’afficher une ligne par pays.</p>
</div>
</div>
</div>
</div>
</section><section id="sans-utiliser-over-..." class="slide level2 center scrollable"><h2>Sans utiliser <code>OVER (...)</code>
</h2>
<p>Pour calculer ce résultat sans fonctions fenêtres :</p>
<ol type="1">
<li><p>On effectue une partition selon la <code>region</code>, une aggrégation par groupe pour calculer <code>min(lifeexpectancy)</code> et <code>max(lifeexpectancy)</code>. On obtient une table à trois colonnes.</p></li>
<li><p>On calcule une (équi)-jointure avec la table <code>country</code> originelle sur la colonne commune <code>region</code>.</p></li>
<li><p>On projette le résultat sur les cinq colonnes pertinentes.</p></li>
</ol>
<div class="fragment">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb55-1"><a></a><span class="kw">WITH</span> R <span class="kw">AS</span> (</span>
<span id="cb55-2"><a></a>  <span class="kw">SELECT</span> region, <span class="fu">min</span>(lifeexpectancy) <span class="kw">AS</span> minlex, <span class="fu">max</span>(lifeexpectancy) <span class="kw">AS</span> maxlex</span>
<span id="cb55-3"><a></a>  <span class="kw">FROM</span> country</span>
<span id="cb55-4"><a></a>  <span class="kw">WHERE</span> region <span class="kw">LIKE</span> <span class="st">'%Countries'</span> <span class="kw">AND</span> lifeexpectancy <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> </span>
<span id="cb55-5"><a></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> region</span>
<span id="cb55-6"><a></a>)</span>
<span id="cb55-7"><a></a></span>
<span id="cb55-8"><a></a><span class="kw">SELECT</span> region, name_country, lifeexpectancy, minlex, maxlex</span>
<span id="cb55-9"><a></a><span class="kw">FROM</span> country co <span class="kw">NATURAL</span> <span class="kw">JOIN</span> R</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</section><section id="fonctions-fenêtres-avec-une-clause-order-by" class="slide level2 center"><h2>Fonctions fenêtres avec une clause <code>ORDER BY</code>
</h2>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>Avec une clause <code>ORDER BY</code>, la fenêtre est restreinte aux lignes qui précèdent la ligne courante (selon l’ordre indiqué dans <code>ORDER BY</code>), après partitionnement.</p>
<p>La ligne courante est incluse dans le calcul.</p>
</div>
</div>
</div>
<div class="fragment">
<div class="columns">
<div class="column" style="width:70%;">
<p>On ajoute <code>ORDER BY lifeexpectancy</code> à l’exemple précédent :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb56-1"><a></a><span class="kw">SELECT</span> region, name_country, lifeexpectancy, </span>
<span id="cb56-2"><a></a>     <span class="fu">min</span>(lifeexpectancy) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> region <span class="kw">ORDER</span> <span class="kw">BY</span> lifeexpectancy),  </span>
<span id="cb56-3"><a></a>     <span class="fu">max</span>(lifeexpectancy) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> region <span class="kw">ORDER</span> <span class="kw">BY</span> lifeexpectancy)   </span>
<span id="cb56-4"><a></a><span class="kw">FROM</span> world.country </span>
<span id="cb56-5"><a></a><span class="kw">WHERE</span> region <span class="kw">LIKE</span> <span class="st">'%Countries'</span></span>
<span id="cb56-6"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> region, lifeexpectancy ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:30%;">
<p>Les 3 premières lignes :</p>
<pre><code>|name_country |lifeexpecta|min |max |
|-------------|-----------|----|----|
|Latvia       |68,4       |68,4|68,4|
|Lithuania    |69,1       |68,4|69,1|
|Estonia      |69,5       |68,4|69,5|
...</code></pre>
</div></div>
</div>
<div class="fragment">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>La colonne <code>min</code> n’a pas changé car la première ligne de la fenêtre contient la valeur minimale de la fenêtre puisqu’on a fait <code>ORDER BY lifeexpectancy</code>.</p>
<p>La colonne <code>max</code> a changé. Elle est maintenant identique à la colonne <code>lifeexpectancy</code> car la ligne courante contient la valeur maximale parmi les lignes qui la précèdent dans “la fenêtre” selon l’ordre <code>lifeexpectancy</code>.</p>
</div>
</div>
</div>
</div>
</section><section id="exemple-de-fonction-fenêtre-avec-une-clause-order-by" class="slide level2 center"><h2>Exemple de fonction fenêtre avec une clause <code>ORDER BY</code>
</h2>
<p><code>row_number()</code> : fonction d’agrégation qui retourne le numéro de la ligne dans la fenêtre.</p>
<div class="fragment">
<p>Pour les pays d’Asie, lister la région, le nom du pays, le rang du pays dans sa région pour l’espérance de vie et le rang du pays dans sa région pour le PNB par habitant.</p>
</div>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb58-1"><a></a><span class="kw">SELECT</span> region, name_country, </span>
<span id="cb58-2"><a></a>  <span class="fu">row_number</span>() <span class="kw">OVER</span> (</span>
<span id="cb58-3"><a></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> region   </span>
<span id="cb58-4"><a></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> lifeexpectancy <span class="kw">DESC</span></span>
<span id="cb58-5"><a></a>  ) <span class="kw">AS</span> rk_lifeexpectancy,</span>
<span id="cb58-6"><a></a>  <span class="fu">row_number</span>() <span class="kw">OVER</span> (</span>
<span id="cb58-7"><a></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> region   </span>
<span id="cb58-8"><a></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> gnp <span class="op">/</span> population_country <span class="kw">DESC</span></span>
<span id="cb58-9"><a></a>  ) <span class="kw">AS</span> rk_gnp </span>
<span id="cb58-10"><a></a><span class="kw">FROM</span> world.country </span>
<span id="cb58-11"><a></a><span class="kw">WHERE</span> continent <span class="kw">LIKE</span> <span class="st">'Asi%'</span> <span class="kw">and</span> lifeexpectancy <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">and</span> gnp <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb58-12"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> region, lifeexpectancy <span class="kw">DESC</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Dans cette requête, il faut rejeter les valeurs <code>NULL</code> sinon le rang n’aurait pas de sens (ces lignes seraient en tête).</p>
</div>
</div>
</div>
</div>
</section><section class="slide level2 center"><p>Y-a-t-il une correlation entre les deux rangs ?</p>
<pre><code>|region                   |name_country        |rk_lifeexpectancy|rk_gnp|
|-------------------------|--------------------|-----------------|------|
|Eastern Asia             |Macao               |1                |3     |
|Eastern Asia             |Japan               |2                |1     |
|Eastern Asia             |Hong Kong           |3                |2     |
|Eastern Asia             |Taiwan              |4                |4     |
|Eastern Asia             |South Korea         |5                |5     |
|Eastern Asia             |China               |6                |6     |
|Eastern Asia             |North Korea         |7                |8     |
|Eastern Asia             |Mongolia            |8                |7     |
|Middle East              |Israel              |1                |2     |
|Middle East              |Jordan              |2                |12    |
|Middle East              |Cyprus              |3                |5     |
|Middle East              |Kuwait              |4                |4     |
|Middle East              |United Arab Emirates|5                |3     |
|Middle East              |Bahrain             |6                |6     |
|Middle East              |Qatar               |7                |1     |
|Middle East              |Oman                |8                |7     |
|Middle East              |Palestine           |9                |13    |
|Middle East              |Lebanon             |10               |9     |
|Middle East              |Turkey              |11               |11    |
|Middle East              |Syria               |12               |10    |
|Middle East              |Saudi Arabia        |13               |8     |
|Middle East              |Iraq                |14               |17    |
|Middle East              |Armenia             |15               |16    |
|Middle East              |Georgia             |16               |14    |
|Middle East              |Azerbaijan          |17               |15    |
|Middle East              |Yemen               |18               |18    |
|Southeast Asia           |Singapore           |1                |2     |
|Southeast Asia           |Brunei              |2                |1     |
|Southeast Asia           |Malaysia            |3                |4     |
|Southeast Asia           |Vietnam             |4                |9     |
|Southeast Asia           |Thailand            |5                |5     |
|Southeast Asia           |Indonesia           |6                |8     |
|Southeast Asia           |Philippines         |7                |6     |
|Southeast Asia           |Cambodia            |8                |7     |
|Southeast Asia           |Myanmar             |9                |3     |
|Southeast Asia           |Laos                |10               |10    |
|Southeast Asia           |East Timor          |11               |11    |
|Southern and Central Asia|Sri Lanka           |1                |4     |
|Southern and Central Asia|Iran                |2                |1     |
|Southern and Central Asia|Tajikistan          |3                |10    |
|Southern and Central Asia|Uzbekistan          |4                |6     |
|Southern and Central Asia|Kyrgyzstan          |5                |9     |
|Southern and Central Asia|Kazakstan           |6                |2     |
|Southern and Central Asia|India               |7                |7     |
|Southern and Central Asia|Maldives            |8                |5     |
|Southern and Central Asia|Pakistan            |9                |8     |
|Southern and Central Asia|Turkmenistan        |10               |3     |
|Southern and Central Asia|Bangladesh          |11               |12    |
|Southern and Central Asia|Nepal               |12               |13    |
|Southern and Central Asia|Bhutan              |13               |14    |
|Southern and Central Asia|Afghanistan         |14               |11    |
</code></pre>
</section><section id="sommes-cumulées-par-groupes-selon-un-ordre" class="slide level2 center"><h2>Sommes cumulées par groupes selon un ordre</h2>
<p>Avec une clause <code>ORDER BY</code>, une fonction fenêtre <code>SUM()</code> effectue une somme cumulée selon l’ordre choisi.</p>
<div class="fragment">
<p>Calculer, pour chaque pays d’Europe, le pourcentage des PNB supérieur ou égal à celui du pays parmi ceux de sa région.</p>
</div>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb60-1"><a></a><span class="kw">SELECT</span> </span>
<span id="cb60-2"><a></a>  region, name_country,  </span>
<span id="cb60-3"><a></a>  <span class="fu">ROUND</span>(<span class="fu">SUM</span>(gnp) <span class="kw">OVER</span> (</span>
<span id="cb60-4"><a></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> region  </span>
<span id="cb60-5"><a></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> gnp <span class="kw">DESC</span>) </span>
<span id="cb60-6"><a></a>  <span class="op">/</span> <span class="fu">sum</span>(gnp) <span class="kw">OVER</span> (</span>
<span id="cb60-7"><a></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> region), <span class="dv">4</span>)<span class="op">*</span><span class="dv">100</span>  </span>
<span id="cb60-8"><a></a>  <span class="kw">AS</span> pc_sum_GNP    </span>
<span id="cb60-9"><a></a><span class="kw">FROM</span> world.country c </span>
<span id="cb60-10"><a></a><span class="kw">WHERE</span> continent <span class="op">=</span> <span class="st">'Europe'</span></span>
<span id="cb60-11"><a></a><span class="kw">order</span> <span class="kw">by</span> region, gnp <span class="kw">DESC</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section class="slide level2 center"><pre><code>|region          |name_country                 |pc_sum_gnp|
|----------------|-----------------------------|----------|
|Baltic Countries|Lithuania                    |47,69     |
|Baltic Countries|Latvia                       |76,23     |
|Baltic Countries|Estonia                      |100       |
|British Islands |United Kingdom               |94,78     |
|British Islands |Ireland                      |100       |
|Eastern Europe  |Russian Federation           |41,91     |
|Eastern Europe  |Poland                       |64,9      |
|Eastern Europe  |Czech Republic               |73,23     |
|Eastern Europe  |Hungary                      |80,55     |
|Eastern Europe  |Ukraine                      |86,94     |
|Eastern Europe  |Romania                      |92,72     |
|Eastern Europe  |Slovakia                     |95,84     |
|Eastern Europe  |Belarus                      |97,92     |
|Eastern Europe  |Bulgaria                     |99,76     |
|Eastern Europe  |Moldova                      |100       |
|Nordic Countries|Sweden                       |33,47     |
|Nordic Countries|Denmark                      |59,2      |
|Nordic Countries|Norway                       |80,76     |
|Nordic Countries|Finland                      |98,78     |
|Nordic Countries|Iceland                      |100       |
|Nordic Countries|Svalbard and Jan Mayen       |100       |
|Nordic Countries|Faroe Islands                |100       |
|Southern Europe |Italy                        |57,73     |
|Southern Europe |Spain                        |85,23     |
|Southern Europe |Greece                       |91,23     |
|Southern Europe |Portugal                     |96,49     |
|Southern Europe |Croatia                      |97,49     |
|Southern Europe |Slovenia                     |98,48     |
|Southern Europe |Yugoslavia                   |99,32     |
|Southern Europe |Malta                        |99,5      |
|Southern Europe |Albania                      |99,66     |
|Southern Europe |Bosnia and Herzegovina       |99,8      |
|Southern Europe |Macedonia                    |99,88     |
|Southern Europe |Andorra                      |99,96     |
|Southern Europe |San Marino                   |99,99     |
|Southern Europe |Gibraltar                    |100       |
|Southern Europe |Holy See (Vatican City State)|100       |
|Western Europe  |Germany                      |45,65     |
|Western Europe  |France                       |76,13     |
|Western Europe  |Netherlands                  |84,07     |
|Western Europe  |Switzerland                  |89,73     |
|Western Europe  |Belgium                      |95,08     |
|Western Europe  |Austria                      |99,61     |
|Western Europe  |Luxembourg                   |99,96     |
|Western Europe  |Liechtenstein                |99,98     |
|Western Europe  |Monaco                       |100       |</code></pre>
</section><section id="limites-dutilisation-des-fonctions-fenêtres" class="slide level2 center"><h2>Limites d’utilisation des fonctions fenêtres</h2>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Avertissement</strong></p>
</div>
<div class="callout-content">
<p>Les fonctions de fenêtre ne sont autorisées que dans les clauses <code>SELECT</code> et <code>ORDER BY</code> de la requête.</p>
<p>Elles sont interdites ailleurs, par exemple dans les clauses <code>GROUP BY</code>, <code>HAVING</code> et <code>WHERE</code>.</p>
<p>En effet, elles s’exécutent logiquement <strong>après</strong> le traitement de ces clauses.</p>
</div>
</div>
</div>
<div class="fragment">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mise en garde</strong></p>
</div>
<div class="callout-content">
<p>De même, les fonctions de fenêtre s’exécutent <em>après</em> les fonctions d’agrégation habituelles.</p>
<p>Cela signifie qu’il est pertinent d’inclure un appel de fonction d’agrégation dans les arguments d’une fonction de fenêtre, mais pas l’inverse.</p>
</div>
</div>
</div>
<!--

## Différentes alternatives pour une même requête

Afficher le pays le plus peuplé 

. . .

::::: {.columns}
::: {.column}

```{.sql}
SELECT S.name_country, 
  S.continent, 
  S.population_country
FROM (
  SELECT max(population_country) AS mpc 
  FROM country c
  ) AS R 
  JOIN LATERAL (    
    SELECT * 
    FROM country c2 
    WHERE c2.population_country >= R.mpc
    ) AS S 
  ON (TRUE) ;
```

:::


::: {.column}

```{.sql}
SELECT c.name_country, 
       c.continent, 
       c.population_country
FROM (
  SELECT max(population_country) AS mpc 
  FROM country c2
  ) AS S
  JOIN country c 
  ON (c.population_country >= S.mpc)    
;
```

:::
:::::



```{.sql}
name_country|continent|population_country|
------------+---------+------------------+
China       |Asia     |        1277558000|
```


## Différentes alternatives  (suite)

Afficher le pays le plus peuplé 

::::: {.columns}
::: {.column}

```{.sql}
SELECT * 
FROM world.country c  
WHERE population_country >= ALL(
  SELECT cc.population_country  
  FROM world.country  cc
) ;     

```

:::
::: {.column}

```{.sql}
WITH S AS (        
  SELECT c.*, max(population_country) 
         OVER () AS mpc  
  FROM world.country c
)
SELECT * 
FROM S   
WHERE population_country >= mpc ;
```

:::
::::: 

```{.sql}
name_country|continent|population_country|
------------+---------+------------------+
China       |Asia     |        1277558000|
```
-->
</div>
</section></section><section><section id="groupements-avancés" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Groupements avancés</h1>

</section><section id="introduction" class="slide level2 center"><h2>Introduction</h2>
<p>Introduits dans SQL avec la mode du <code>Data mining</code> (Fouille de données) dans les années 1990.</p>
<p>Permet de réaliser de facon apparemment simultanée des aggrégations de régularités emboîtées.</p>
<p>Dans le monde des statistiques, lorsqu’on aggrège des comptages de grains différents, on parle de tables de contingences (<em>contingency tables</em>).</p>
<p><a href="https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-GROUPING-SETS" target="_blank">Documentation PostgreSQL</a></p>
</section><section id="grouping-sets" class="slide level2 center"><h2>GROUPING SETS</h2>
<p>Un <code>GROUPING SETS</code> permet d’effectuer simultanément des calculs d’agrégats pour différentes partitions de la table.</p>
<p>Il s’écrit dans la clause <code>GROUP BY</code> avec une liste d’ensemble d’attributs de la forme <code>((c1,c2), (c1), (c2))</code>.</p>
<p><code>GROUP BY GROUPING SETS ((c1,c2), (c1), ())</code></p>
<p>signifie que l’on fera les calculs d’agrégats successivement pour les regroupements selon <code>c1,c2</code>, puis pour les regroupements selon <code>c1</code>, puis sans regroupement.</p>
<p>Dans le résultat, lorsque le partitionnement selon <code>c1</code> est effectué, la colonne <code>c2</code> a la valeur <code>NULL</code> (i.e.&nbsp;pas de valeur), ce qui cohérent avec le fonctionnement de <code>GROUP BY</code>.</p>
</section><section class="slide level2 center"><p>On suppose que les colonnes <code>c1</code> et <code>c2</code> de la table <code>t</code> ne contiennent chacune que 2 valeurs distinctes.</p>
<p>La requête</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb62-1"><a></a><span class="kw">SELECT</span> c1, c2, aggregate_function( <span class="op">..</span>. ) <span class="kw">as</span> f</span>
<span id="cb62-2"><a></a><span class="kw">FROM</span> t</span>
<span id="cb62-3"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS ((c1,c2), (c2), ());   </span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>donne un résultat de la forme :</p>
<pre><code>|c1    |c2    |f    |
|------|------|-----|
|x1    |y1    |z1   |
|x1    |y2    |z2   |
|x2    |y1    |z3   |
|x2    |y2    |z4   |
|      |y1    |z5   |
|      |y2    |z6   |
|      |      |z7   |</code></pre>
</section><section id="exemple-avec-grouping-sets" class="slide level2 center"><h2>Exemple avec <code>GROUPING SETS</code>
</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb64-1"><a></a><span class="kw">SELECT</span> continent, region, <span class="fu">max</span>(lifeexpectancy)</span>
<span id="cb64-2"><a></a><span class="kw">FROM</span> country c </span>
<span id="cb64-3"><a></a><span class="kw">WHERE</span> continent <span class="kw">LIKE</span> <span class="st">'%America'</span></span>
<span id="cb64-4"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS  ((continent, region), (continent), ())  </span>
<span id="cb64-5"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> continent, region ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>|continent    |region         |max |
|-------------|---------------|----|
|North America|Caribbean      |78,9|
|North America|Central America|75,8|
|North America|North America  |79,4|
|North America|               |79,4|
|South America|South America  |76,1|
|South America|               |76,1|
|             |               |79,4|</code></pre>
</section><section id="rollup" class="slide level2 center"><h2>ROLLUP</h2>
<p><code>ROLLUP ( a, b, c, ... )</code></p>
<p>est un raccourci pour</p>
<pre><code>GROUPING SETS (
    ( a, b, c, ... ),
    ...
    ( a, b ),
    ( a ),
    ( )
)</code></pre>
</section><section id="exemple-avec-rollup" class="slide level2 center"><h2>Exemple avec <code>ROLLUP</code>
</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb67-1"><a></a><span class="kw">SELECT</span> continent, region, <span class="fu">max</span>(lifeexpectancy)</span>
<span id="cb67-2"><a></a><span class="kw">FROM</span> country c </span>
<span id="cb67-3"><a></a><span class="kw">WHERE</span> continent <span class="kw">LIKE</span> <span class="st">'%America'</span></span>
<span id="cb67-4"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span>  (continent, region)  </span>
<span id="cb67-5"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> continent, region ;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<pre><code>+-------------+---------------+----+
|Continent    |Region         |max |
+-------------+---------------+----+
|North America|Caribbean      |78.9|
|North America|Central America|75.8|
|North America|North America  |79.4|
|North America|               |79.4|
|South America|South America  |76.1|
|South America|               |76.1|
|             |               |79.4|</code></pre>
</section><section id="cube" class="slide level2 center"><h2><code>CUBE</code></h2>
<p><code>CUBE (a, b, c)</code> est un raccourci pour un <code>GROUPING SETS</code> contenant toutes les parties de <code>(a, b, c)</code>, c.a.d</p>
<pre><code>GROUPING SETS (
    (         )
    ( a, b, c ),
    ( a, b    ),
    ( a       ),
    (    b, c ),
    (    b    ),
    ( a,    c ),
    (       c ),
)</code></pre>
</section><section id="exemple-avec-cube" class="slide level2 center"><h2>Exemple avec <code>CUBE</code>
</h2>
<div class="columns">
<div class="column" style="width:43%;">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb70-1"><a></a><span class="kw">SELECT</span> continent, region, governmentform, </span>
<span id="cb70-2"><a></a>       <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> cnt, </span>
<span id="cb70-3"><a></a>       <span class="fu">max</span>(lifeexpectancy)</span>
<span id="cb70-4"><a></a><span class="kw">FROM</span> country c </span>
<span id="cb70-5"><a></a><span class="kw">WHERE</span> continent <span class="kw">LIKE</span> <span class="st">'%America'</span></span>
<span id="cb70-6"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">CUBE</span> (continent,region,governmentform)</span>
<span id="cb70-7"><a></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">5</span>;</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div><div class="column" style="width:57%;">
<pre><code>|continent    |region         |governmentform               |cnt|max |
|-------------|---------------|-----------------------------|---|----|
|             |               |                             |51 |79,4|
|South America|South America  |Republic                     |9  |75,7|
|North America|Central America|Republic                     |6  |75,8|
|North America|Caribbean      |Constitutional Monarchy      |8  |75,2|
|North America|Caribbean      |                             |24 |78,9|
|South America|South America  |                             |14 |76,1|
|North America|Central America|                             |8  |75,8|
|South America|               |                             |14 |76,1|
|North America|               |                             |37 |79,4|
|             |Caribbean      |Constitutional Monarchy      |8  |75,2|
|             |South America  |Republic                     |9  |75,7|
|             |Central America|Republic                     |6  |75,8|
|             |South America  |                             |14 |76,1|
|             |Central America|                             |8  |75,8|
|             |Caribbean      |                             |24 |78,9|
|North America|               |Constitutional Monarchy      |9  |75,2|
|North America|               |Republic                     |10 |75,8|
|South America|               |Republic                     |9  |75,7|
|North America|               |Dependent Territory of the UK|6  |78,9|
|             |               |Republic                     |19 |75,8|
|             |               |Constitutional Monarchy      |9  |75,2|
|             |               |Dependent Territory of the UK|7  |78,9|</code></pre>
</div></div>
</section></section><section><section id="résumé" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Résumé</h1>

</section><section id="portrait-robot-dune-requête" class="slide level2 center"><h2>Portrait robot d’une requête</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb72-1"><a></a><span class="kw">SELECT</span> <span class="op">&lt;</span>attributs<span class="op">&gt;</span>           <span class="co">-- les colonnes de la table résultat</span></span>
<span id="cb72-2"><a></a></span>
<span id="cb72-3"><a></a><span class="kw">FROM</span> <span class="op">&lt;</span>relations<span class="op">&gt;</span>             <span class="co">-- la/les table/s qui émettent les données</span></span>
<span id="cb72-4"><a></a></span>
<span id="cb72-5"><a></a>[<span class="kw">WHERE</span> <span class="op">&lt;</span>condition<span class="op">&gt;</span> ]         <span class="co">-- filtre</span></span>
<span id="cb72-6"><a></a></span>
<span id="cb72-7"><a></a>[<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="op">&lt;</span>attributs de partitionnement<span class="op">&gt;</span>   <span class="co">-- découpage en groupes</span></span>
<span id="cb72-8"><a></a></span>
<span id="cb72-9"><a></a>[<span class="kw">HAVING</span> <span class="op">&lt;</span>condition<span class="op">&gt;</span>]]      <span class="co">-- filtrage des groupes</span></span>
<span id="cb72-10"><a></a></span>
<span id="cb72-11"><a></a>[<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span>critere<span class="op">&gt;</span>]       <span class="co">-- trier </span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>
<code>SELECT</code> : attributs du résultat (avec agrégations éventuelles)</li>
<li>
<code>WHERE</code> : condition de sélection indépendante du <code>GROUP BY</code>
</li>
<li>
<code>HAVING</code> : condition de sélection portant sur les groupes</li>
</ul>
<!--
---

::: {.callout-caution}

### Avis 

Toutes les requêtes  SQL contiennent une combinaison de ces clauses. Retenez au moins cela!

:::

```{.sql}
SELECT        -- columns to display
FROM          -- table(s) to pull from
WHERE         -- filter
GROUP BY      -- split rows into groups
HAVING        -- filter within groups
ORDER BY      -- sort
```
--></section><section id="ordre-dexécution-des-éléments-dune-requête" class="slide level2 center scrollable"><h2>Ordre d’exécution des éléments d’une requête</h2>
<ol type="1">
<li><p>Rassembler les données mentionnées dans la clause <code>FROM</code></p></li>
<li><p>Filter les lignes selon la clause <code>WHERE</code></p></li>
<li><p>Regrouper les lignes selon la clause <code>GROUP BY</code></p></li>
<li><p>Filtrer les groupes selon la clause <code>HAVING</code></p></li>
<li><p>Specifier les colonnes du résultat selon la clause <code>SELECT</code></p></li>
<li><p>Trier le résultat final selon la clause <code>ORDER BY</code></p></li>
</ol></section></section><section><section id="références" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Références</h1>

</section><section class="slide level2 center"><p><a href="https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-select/" target="_blank">Tutoriel <code>SELECT</code> de PostGreSQL</a></p>
<p><a href="https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-joins/" target="_blank">Tutoriel <code>joins</code></a></p>
<p><a href="https://www.postgresql.org/docs/current/queries.html" target="_blank">Documentation requêtes</a></p>
<p><a href="https://www.postgresql.org/docs/14/sql-select.html" target="_blank">Documentation <code>SELECT</code></a></p>
<p><a href="https://www.postgresql.org/docs/14/queries-table-expressions.html#QUERIES-GROUPING-SETS" target="_blank">GROUPING SETS, ROLLUP, CUBE</a></p>
</section><section class="slide level2 center"></section></section><section id="fin" class="title-slide slide level1 center" data-background-color="#1c191c"><h1>Fin</h1>


<div class="reveal-header">
<div class="header-logo" data-header-logo-link="https://u-paris.fr">
<img data-src="..\images/logo.png">
</div>
<div class="sc-title">
<p> </p>
</div>
<div class="header-text">
<p>Requêtes SQL : Aggrégation/Fenêtres/Partition</p>
</div>
<div class="sb-title">
<p> </p>
</div>
</div>
</section>
</div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="../images/UniversiteParis_monogramme_couleur_RVB.png" class="slide-logo"></p>
<div class="footer footer-default">
<p><a href="http://bgentou.github.io/MA15E045">MA15E045</a> – Bases de Données – L3 MIASHS – UParis Cité</p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="../site_libs/revealjs/dist/reveal.js"></script><!-- reveal.js plugins --><script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script><script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script><script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script><script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script><script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script><script src="../site_libs/revealjs/plugin/notes/notes.js"></script><script src="../site_libs/revealjs/plugin/search/search.js"></script><script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script><script src="../site_libs/revealjs/plugin/math/math.js"></script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: true,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'bottom-right',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: true,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script><script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }
    
        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();
    
          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }
    
        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }
    
      })();
    </script><script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copié");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copié");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp("https:\/\/bgentou\.github\.io\/MA15E045\/");
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
                // target, if specified
                link.setAttribute("target", "_blank");
                if (link.getAttribute("rel") === null) {
                  link.setAttribute("rel", "noopener");
                }
                // default icon
                link.classList.add("external");
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
            let selectedAnnoteEl;
            const selectorForAnnotation = ( cell, annotation) => {
              let cellAttr = 'data-code-cell="' + cell + '"';
              let lineAttr = 'data-code-annotation="' +  annotation + '"';
              const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
              return selector;
            }
            const selectCodeLines = (annoteEl) => {
              const doc = window.document;
              const targetCell = annoteEl.getAttribute("data-target-cell");
              const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
              const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
              const lines = annoteSpan.getAttribute("data-code-lines").split(",");
              const lineIds = lines.map((line) => {
                return targetCell + "-" + line;
              })
              let top = null;
              let height = null;
              let parent = null;
              if (lineIds.length > 0) {
                  //compute the position of the single el (top and bottom and make a div)
                  const el = window.document.getElementById(lineIds[0]);
                  top = el.offsetTop;
                  height = el.offsetHeight;
                  parent = el.parentElement.parentElement;
                if (lineIds.length > 1) {
                  const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
                  const bottom = lastEl.offsetTop + lastEl.offsetHeight;
                  height = bottom - top;
                }
                if (top !== null && height !== null && parent !== null) {
                  // cook up a div (if necessary) and position it 
                  let div = window.document.getElementById("code-annotation-line-highlight");
                  if (div === null) {
                    div = window.document.createElement("div");
                    div.setAttribute("id", "code-annotation-line-highlight");
                    div.style.position = 'absolute';
                    parent.appendChild(div);
                  }
                  div.style.top = top - 2 + "px";
                  div.style.height = height + 4 + "px";
                  div.style.left = 0;
                  let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
                  if (gutterDiv === null) {
                    gutterDiv = window.document.createElement("div");
                    gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                    gutterDiv.style.position = 'absolute';
                    const codeCell = window.document.getElementById(targetCell);
                    const gutter = codeCell.querySelector('.code-annotation-gutter');
                    gutter.appendChild(gutterDiv);
                  }
                  gutterDiv.style.top = top - 2 + "px";
                  gutterDiv.style.height = height + 4 + "px";
                }
                selectedAnnoteEl = annoteEl;
              }
            };
            const unselectCodeLines = () => {
              const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
              elementsIds.forEach((elId) => {
                const div = window.document.getElementById(elId);
                if (div) {
                  div.remove();
                }
              });
              selectedAnnoteEl = undefined;
            };
              // Handle positioning of the toggle
          window.addEventListener(
            "resize",
            throttle(() => {
              elRect = undefined;
              if (selectedAnnoteEl) {
                selectCodeLines(selectedAnnoteEl);
              }
            }, 10)
          );
          function throttle(fn, ms) {
          let throttle = false;
          let timer;
            return (...args) => {
              if(!throttle) { // first call gets through
                  fn.apply(this, args);
                  throttle = true;
              } else { // all the others get throttled
                  if(timer) clearTimeout(timer); // cancel #2
                  timer = setTimeout(() => {
                    fn.apply(this, args);
                    timer = throttle = false;
                  }, ms);
              }
            };
          }
            const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
            for (let i=0; i<annoteTargets.length; i++) {
              const annoteTarget = annoteTargets[i];
              const targetCell = annoteTarget.getAttribute("data-target-cell");
              const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
              const contentFn = () => {
                const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
                if (content) {
                  const tipContent = content.cloneNode(true);
                  tipContent.classList.add("code-annotation-tip-content");
                  return tipContent.outerHTML;
                }
              }
              const config = {
                allowHTML: true,
                content: contentFn,
                onShow: (instance) => {
                  selectCodeLines(instance.reference);
                  instance.reference.classList.add('code-annotation-active');
                  window.tippy.hideAll();
                },
                onHide: (instance) => {
                  unselectCodeLines();
                  instance.reference.classList.remove('code-annotation-active');
                },
                maxWidth: 300,
                delay: [50, 0],
                duration: [200, 0],
                offset: [5, 10],
                arrow: true,
                appendTo: function(el) {
                  return el.parentElement.parentElement.parentElement;
                },
                interactive: true,
                interactiveBorder: 10,
                theme: 'light-border',
                placement: 'right',
                popperOptions: {
                  modifiers: [
                  {
                    name: 'flip',
                    options: {
                      flipVariations: false, // true by default
                      allowedAutoPlacements: ['right'],
                      fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                    },
                  },
                  {
                    name: 'preventOverflow',
                    options: {
                      mainAxis: false,
                      altAxis: false
                    }
                  }
                  ]        
                }      
              };
              window.tippy(annoteTarget, config); 
            }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script><script type="text/javascript">
        (function(d) {
          d.querySelectorAll(".pseudocode-container").forEach(function(el) {
            let pseudocodeOptions = {
              indentSize: el.dataset.indentSize || "1.2em",
              commentDelimiter: el.dataset.commentDelimiter || "//",
              lineNumber: el.dataset.lineNumber === "true" ? true : false,
              lineNumberPunc: el.dataset.lineNumberPunc || ":",
              noEnd: el.dataset.noEnd === "true" ? true : false,
              titlePrefix: el.dataset.captionPrefix || "Algorithm"
            };
            pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
          });
        })(document);
        (function(d) {
          d.querySelectorAll(".pseudocode-container").forEach(function(el) {
            let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
            if (captionSpan !== null) {
              let captionPrefix = el.dataset.captionPrefix + " ";
              let captionNumber = "";
              if (el.dataset.pseudocodeNumber) {
                captionNumber = el.dataset.pseudocodeNumber + " ";
                if (el.dataset.chapterLevel) {
                  captionNumber = el.dataset.chapterLevel + "." + captionNumber;
                }
              }
              captionSpan.innerHTML = captionPrefix + captionNumber;
            }
          });
        })(document);
        </script>


</body></html>