<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stéphane Boucheron">

<title>BD : Fonctions et extension PlpgSQL de SQL – MA15Y030 - Automne 2024</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<meta property="og:title" content="BD : Fonctions et extension PlpgSQL de SQL – MA15Y030 - Automne 2024">
<meta property="og:description" content="Page maison pour MA15Y030 - Bases de données, Licence MIASHS Automne 2024.">
<meta property="og:site_name" content="MA15Y030 - Automne 2024">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">BD : Fonctions et extension PlpgSQL de SQL</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/s-v-b/MA15Y030" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Moodle" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Moodle"><i class="bi bi-person-fill"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=2313">
            Discussion forum
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=2313">
            Dépot
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://moodle.u-paris.fr/course/view.php?id=2313">
            Notes
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Course information</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-apercu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Aperçu</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-support.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Support</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-equipe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Équipe</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agenda</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-liens.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Liens</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cours-faq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FAQ</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Computing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing-access.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Access</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing-dbeaver.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">dbeaver</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing-troubleshooting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Troubleshooting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Project</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../project-description.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../project-tips-resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tips + resources</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Weekly materials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../weeks/week-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Roadmap</h2>
   
  <ul>
  <li><a href="#fonctions-plpgsql-introduction-et-exemples" id="toc-fonctions-plpgsql-introduction-et-exemples" class="nav-link active" data-scroll-target="#fonctions-plpgsql-introduction-et-exemples">Fonctions plpgSQL: introduction et exemples</a></li>
  <li><a href="#un-premier-cas-fonctions-issues-du-schéma-sakila" id="toc-un-premier-cas-fonctions-issues-du-schéma-sakila" class="nav-link" data-scroll-target="#un-premier-cas-fonctions-issues-du-schéma-sakila">Un premier cas : fonctions issues du schéma <code>sakila</code></a></li>
  <li><a href="#un-deuxième-cas-surveillance-et-maintenance" id="toc-un-deuxième-cas-surveillance-et-maintenance" class="nav-link" data-scroll-target="#un-deuxième-cas-surveillance-et-maintenance">Un deuxième cas : surveillance et maintenance</a></li>
  <li><a href="#extension-de-sql-en-un-langage-procédural" id="toc-extension-de-sql-en-un-langage-procédural" class="nav-link" data-scroll-target="#extension-de-sql-en-un-langage-procédural">Extension de SQL en un langage procédural</a></li>
  <li><a href="#un-exemple-plus-complexe-issu-de-sakila" id="toc-un-exemple-plus-complexe-issu-de-sakila" class="nav-link" data-scroll-target="#un-exemple-plus-complexe-issu-de-sakila">Un exemple plus complexe issu de <code>sakila</code></a></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/s-v-b/MA15Y030/edit/main/slides/SQL_5.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/s-v-b/MA15Y030/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="SQL_5.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BD : Fonctions et extension PlpgSQL de SQL</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Stéphane Boucheron </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            LPSM Université Paris-Cité
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="fonctions-plpgsql-introduction-et-exemples" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Fonctions plpgSQL: introduction et exemples</h1>
<p>Pourquoi étendre SQL ?</p>
<section id="trois-objectifs" class="level2">
<h2 class="anchored" data-anchor-id="trois-objectifs">Trois objectifs</h2>
<ol type="1">
<li>Automatisation de taches répétitives (administration)</li>
</ol>
<ul>
<li>On veut répéter une même tache sur une collection de schémas</li>
<li>On veut traiter une collection de roles</li>
<li></li>
</ul>
<ol start="2" type="1">
<li>Calculs impossibles à réaliser en SQL :</li>
</ol>
<ul>
<li>Calculer la <em>fermeture transitive</em> d’une relation comme <code>film_actors</code><br>
</li>
<li>L’algèbre relationnelle est un modèle de calculabilité restreint·</li>
</ul>
<ol start="3" type="1">
<li><code>Triggers</code></li>
</ol>
<ul>
<li>Certaines contraintes ne peuvent pas être mises en place avec les seules constructions <code>primary key</code> , <code>unique</code>, <code>foreign key</code>, <code>check</code> et <code>exclude</code> (notamment des contraintes d’exclusion qui mettent en jeu plusieurs tables).</li>
<li>On peut les maintenir à l’aide de traitements spéciaux : les <code>triggers</code></li>
<li>Les triggers reposent sur des fonctions spéciales</li>
</ul>
<p>. . .</p>
<p>Extensions procédurales de SQL</p>
<p><code>plpgsql</code> : <em>Programming Language PostGres SQL</em></p>
</section>
<section id="automatisation-des-tâches-répétitives-deux-outils-nécessaires" class="level2">
<h2 class="anchored" data-anchor-id="automatisation-des-tâches-répétitives-deux-outils-nécessaires">Automatisation des tâches répétitives : deux outils nécessaires</h2>
<p>Lorsqu’on administre une base, on doit souvent engendrer des <em>requêtes dynamiques</em> à l’intérieur d’une fonction <code>PL/pgSQL</code>, c’est à dire des commandes qui vont concerner des tables ou des types différents à chaque exécution</p>
<p>Les <em>requêtes préparées</em> sont alors très utilement combinées avec les <em>structures de contrôle</em> (itérations, alternatives) pour automatiser les tâches !</p>
<p>. . .</p>
<p><i class="fa-solid fa-screwdriver-wrench" aria-label="screwdriver-wrench"></i> 2 outils (pour étendre SQL) :</p>
<ul>
<li>requêtes dynamiques <code>EXECUTE, PREPARE</code></li>
<li>structures de contrôles <code>IF, LOOP, ...</code> <em>Transforment SQL en un langage de programmation</em></li>
</ul>
<hr>
<p>On commence par des exemples !</p>
</section>
</section>
<section id="un-premier-cas-fonctions-issues-du-schéma-sakila" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Un premier cas : fonctions issues du schéma <code>sakila</code></h1>
<section id="fonction-inventory_in_stock" class="level2">
<h2 class="anchored" data-anchor-id="fonction-inventory_in_stock">Fonction <code>inventory_in_stock()</code></h2>
<p>Objectif : calculer si un dvd est en stock ou pas</p>
<p>Un DVD est en stock</p>
<ul>
<li>s’il n’a jamais été loué</li>
</ul>
<p><strong>OU</strong></p>
<ul>
<li>si toutes les locations de ce DVD sont déjà terminées (<code>return_date</code> n’est pas nul)</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- AN ITEM IS IN-STOCK IF THERE ARE EITHER NO ROWS IN THE rental TABLE</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- FOR THE ITEM OR ALL ROWS HAVE return_date POPULATED</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fonction-inventory_in_stock-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="fonction-inventory_in_stock-1">Fonction <code>inventory_in_stock</code></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> sakila.inventory_in_stock(p_inventory_id <span class="dt">integer</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> RETURNS <span class="dt">boolean</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> LANGUAGE plpgsql</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> $function$</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span>                 </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    v_rentals <span class="dt">INTEGER</span>;  #<span class="op">&lt;&lt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    v_out     <span class="dt">INTEGER</span>;  #<span class="op">&lt;&lt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">INTO</span> v_rentals  #<span class="op">&lt;&lt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> rental</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> inventory_id <span class="op">=</span> p_inventory_id;</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> v_rentals <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span>   #<span class="op">&lt;&lt;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RETURN</span> <span class="kw">TRUE</span>;          #<span class="op">&lt;&lt;</span> </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;                 #<span class="op">&lt;&lt;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">COUNT</span>(rental_id) <span class="kw">INTO</span> v_out     #<span class="op">&lt;&lt;</span> </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> inventory <span class="kw">LEFT</span> <span class="kw">JOIN</span> rental <span class="kw">USING</span>(inventory_id)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> inventory.inventory_id <span class="op">=</span> p_inventory_id <span class="kw">AND</span> rental.return_date <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> v_out <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RETURN</span> <span class="kw">FALSE</span>;</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RETURN</span> <span class="kw">TRUE</span>;</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> $function$ ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Permissions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">FUNCTION</span> sakila.inventory_in_stock(int4) OWNER <span class="kw">TO</span> postgres;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> sakila.inventory_in_stock(int4) <span class="kw">TO</span> postgres;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i></h2>
<ul>
<li><code>SELECT ... INTO ...</code></li>
</ul>
<p>Le résultat de la requête est ici un entier, il est affecté à une variable locale comme <code>v_rentals</code>, <code>v_out</code>, …</p>
<p>En <code>plpgsql</code>, le résultat d’une requête doit être mémorisé ou explicitement négligé en utilisant <code>PERFORM</code> plutôt que <code>SELECT</code></p>
<ul>
<li><code>IF ... THEN ...</code></li>
</ul>
<p>Alternative, comme dans un langage de programmation ordinaire</p>
<ul>
<li><code>RETURN</code></li>
</ul>
<p>Retourne le résultat et termine l’exécution de la fonction</p>
</section>
</section>
<section id="un-deuxième-cas-surveillance-et-maintenance" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Un deuxième cas : surveillance et maintenance</h1>
<section id="une-tâche-de-surveillancemaintenance" class="level2">
<h2 class="anchored" data-anchor-id="une-tâche-de-surveillancemaintenance">Une tâche de surveillance/maintenance</h2>
<p><i class="fa-solid fa-bullseye" aria-label="bullseye"></i></p>
<p>Déterminer pour chaque usager (<em>schéma</em>) le nombre de tuples dans la table <code>ville_pays</code> de cet usager.</p>
<p>Pour chaque schéma <code>schema</code>, on veut évaluer une requête</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">schema</span>.ville_pays ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ici <code>schema</code> doit être calculé en interrogeant le SGBD</p>
<p>. . .</p>
<p>Situation inédite :</p>
<ul>
<li>comment déterminer les schémas pertinents ?</li>
</ul>
</section>
<section id="la-métabase-information_schema-et-pg_catalog" class="level2">
<h2 class="anchored" data-anchor-id="la-métabase-information_schema-et-pg_catalog">La métabase : <code>information_schema</code> et <code>pg_catalog</code></h2>
<p>On va s’aider des tables d’administration du SGBD</p>
<p>Chaque usager correspond à un <code>role</code> et ce rôle correspond dans notre cas à un schema créé à partir du rôle via l’instruction</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> <span class="kw">AUTHORIZATION</span> user_name ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On a envie d’écrire une requête comme</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> username.tournaments ; </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>où <code>username</code> est collectée à partir de</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> usename  <span class="kw">FROM</span> pg_catalog.pg_user ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="deux-schémas-pour-ladministration-la-métabase" class="level2">
<h2 class="anchored" data-anchor-id="deux-schémas-pour-ladministration-la-métabase">Deux schémas pour l’administration : la <strong>métabase</strong></h2>
<ol type="1">
<li><code>information_schema</code></li>
</ol>
<p>Ce schema contient l’information sur les <code>schémas</code> du cluster/catalogue :</p>
<ul>
<li>les définitions de tables, de vues, de colonnes, les contraintes, …</li>
<li>il est formé de tables et surtout de (très nombreuses) vues</li>
<li>les instructions, <code>CREATE, ALTER,  DROP</code> modifient le contenu de ce schéma (une seule instruction <code>ALTER  TABLE</code> peut engendrer plusieurs mises à jours dans les tables de <code>information_schema</code></li>
</ul>
<ol start="2" type="1">
<li><code>pg_catalog</code></li>
</ol>
<p>Ce schema contient lui aussi beaucoup de tables et de vues utiles au fonctionnement du serveur</p>
</section>
<section id="exemple-de-vue-de-pg_catalog-pg_user" class="level2">
<h2 class="anchored" data-anchor-id="exemple-de-vue-de-pg_catalog-pg_user">Exemple de vue de <code>pg_catalog</code> : <code>pg_user</code></h2>
<div class="columns">
<div class="column">
<p>Schéma</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>+--------------+---------+-------------+</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>| Column       | Type    | Modifiers   |</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>|--------------+---------+-------------|</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>| usename      | name    |             |</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>| usesysid     | oid     |             |</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>| usecreatedb  | boolean |             |</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>| usesuper     | boolean |             |</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>| userepl      | boolean |             |</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>| usebypassrls | boolean |             |</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>| passwd       | text    |             |</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>| valuntil     | abstime |             |</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>| useconfig    | text[]  |             |</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>+--------------+---------+-------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column">
<p><code>pg_user</code> nous renseigne sur :</p>
<ul>
<li><i class="fa-solid fa-user" aria-label="user"></i> les usagers (<code>usename</code>)</li>
<li><i class="fa-solid fa-user-plus" aria-label="user-plus"></i> leur statut (<code>usesuper</code> : super-utilisateur ou pas)</li>
<li><i class="fa-solid fa-scale-balanced" aria-label="scale-balanced"></i> leurs privilèges (<code>createdb</code> : peut créer une base ou non)</li>
</ul>
</div>
</div>
</section>
<section id="autre-exemple-dusage-de-la-métabase" class="level2">
<h2 class="anchored" data-anchor-id="autre-exemple-dusage-de-la-métabase">Autre exemple d’usage de la métabase</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> datname, application_name, client_addr, backend_start, state </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_catalog.pg_stat_activity psa </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> datname<span class="op">=</span><span class="st">'bd_2023'</span>;                                               </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+-------------------------------------------+---------------+-------------------------------+---------+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>| datname   | application_name                          | client_addr   | backend_start                 | state   |</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>|<span class="co">-----------+-------------------------------------------+---------------+-------------------------------+---------|</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>| bd_2023   | DBeaver <span class="dv">22</span>.<span class="fl">2.0</span> <span class="op">-</span> Main <span class="op">&lt;</span>bd_2023<span class="op">&gt;</span>           | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span>     | <span class="dv">2022</span><span class="op">-</span><span class="dv">10</span><span class="op">-</span><span class="dv">04</span> <span class="dv">22</span><span class="ch">:48:59</span><span class="fl">.57231</span><span class="op">+</span><span class="dv">02</span>  | idle    |</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>| bd_2023   | DBeaver <span class="dv">22</span>.<span class="fl">2.0</span> <span class="op">-</span> Metadata <span class="op">&lt;</span>bd_2023<span class="op">&gt;</span>       | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span>     | <span class="dv">2022</span><span class="op">-</span><span class="dv">10</span><span class="op">-</span><span class="dv">04</span> <span class="dv">22</span><span class="ch">:48:59</span><span class="fl">.693656</span><span class="op">+</span><span class="dv">02</span> | idle    |</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>| bd_2023   | DBeaver <span class="dv">22</span>.<span class="fl">2.0</span> <span class="op">-</span> SQLEditor <span class="op">&lt;</span>Script<span class="op">-</span><span class="fl">4.</span>sql<span class="op">&gt;</span> | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span>     | <span class="dv">2022</span><span class="op">-</span><span class="dv">10</span><span class="op">-</span><span class="dv">04</span> <span class="dv">22</span><span class="ch">:48:59</span><span class="fl">.958616</span><span class="op">+</span><span class="dv">02</span> | idle    |</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>| bd_2023   | pgcli                                     | <span class="op">&lt;</span><span class="kw">null</span><span class="op">&gt;</span>        | <span class="dv">2022</span><span class="op">-</span><span class="dv">10</span><span class="op">-</span><span class="dv">04</span> <span class="dv">23</span><span class="ch">:23:19</span><span class="fl">.739258</span><span class="op">+</span><span class="dv">02</span> | active  |</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>| bd_2023   | pgcli                                     | <span class="op">&lt;</span><span class="kw">null</span><span class="op">&gt;</span>        | <span class="dv">2022</span><span class="op">-</span><span class="dv">10</span><span class="op">-</span><span class="dv">04</span> <span class="dv">23</span><span class="ch">:23:19</span><span class="fl">.770006</span><span class="op">+</span><span class="dv">02</span> | idle    |</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+-------------------------------------------+---------------+-------------------------------+---------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p>Renseigne sur les utilisateurs ayant une session en cours sur la base <code>bd_2023</code></p>
<hr>
</section>
<section id="tentative" class="level2">
<h2 class="anchored" data-anchor-id="tentative">Tentative</h2>
<p>On engendre <em>dynamiquement</em> une série de requêtes par une instruction de la forme :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SELECT '</span> <span class="op">||</span> quote_literal(usename) <span class="op">||</span> <span class="st">', COUNT(*)  FROM '</span> <span class="op">||</span> usename <span class="op">||</span> <span class="st">'.ville_pays ;'</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_catalog.pg_user  ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><i class="fa-solid fa-brain" aria-label="brain"></i> A quoi sert <code>quote_literal()</code> ?</p>
<hr>
</section>
<section id="le-résultat-est-une-table-de-chaines-de-caractères" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-résultat-est-une-table-de-chaines-de-caractères">Le résultat est une table de chaines de caractères</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rqt                                                      |</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">---------------------------------------------------------+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'postgres'</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)  <span class="kw">FROM</span> postgres.ville_pays ;  |</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'shinken'</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)  <span class="kw">FROM</span> shinken.ville_pays ;    |</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'aalahy99'</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)  <span class="kw">FROM</span> aalahy99.ville_pays ;  |</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'etemam'</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)  <span class="kw">FROM</span> etemam.ville_pays ;      |</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'durand'</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)  <span class="kw">FROM</span> durand.ville_pays ;      |</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>. . .</p>
<p>Tel quel, cela ne fonctionnera pas !</p>
<ul>
<li><p>Il faut pouvoir confier ces chaines de caractères à l’évaluateur de requêtes</p></li>
<li><p>Il faut pouvoir le faire pour chacune des chaines de caractères produites par la requête (itérer)</p></li>
</ul>
<hr>
</section>
<section id="mode-opératoire" class="level2">
<h2 class="anchored" data-anchor-id="mode-opératoire">Mode opératoire</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> taille_ville_pays()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>LANGUAGE plpgsql RETURNS  TEXT <span class="kw">AS</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  stmt <span class="dt">CHARACTER</span> <span class="dt">VARYING</span> ;</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  usename <span class="dt">CHARACTER</span> <span class="dt">VARYING</span> ;</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  result <span class="dt">CHARACTER</span> <span class="dt">VARYING</span>    <span class="op">:=</span> <span class="st">''</span> ;</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  resp <span class="dt">CHARACTER</span> <span class="dt">VARYING</span> <span class="op">:=</span> <span class="st">''</span> ;</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">FOR</span> usename <span class="kw">IN</span> <span class="kw">SELECT</span> u.usename  #<span class="op">&lt;&lt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> pg_catalog.pg_user <span class="kw">AS</span> u <span class="kw">JOIN</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  information_schema.<span class="kw">tables</span> t <span class="kw">ON</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  (u.usename<span class="op">=</span>t.table_schema <span class="kw">and</span> t.table_name <span class="op">=</span><span class="st">'ville_pays'</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="cf">LOOP</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  stmt <span class="op">=</span> <span class="st">'SELECT CAST(COUNT(*) AS VARCHAR) FROM '</span><span class="op">||</span> usename<span class="op">||</span><span class="st">'.ville_pays #&lt;&lt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="st">  result:=result || usename || '</span>: <span class="st">' ||resp| '</span>; <span class="st">';   #&lt;&lt; </span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">END LOOP ;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="st">RETURN result ; #&lt;&lt; </span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="st">END;$$ ;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p>Nous utilisons une des structures itératives de <code>plpgSQL</code> :</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">FOR</span> v <span class="kw">IN</span> expression </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">LOOP</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  instructions</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">LOOP</span> ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>. . .</p>
<ul>
<li>On itère sur les tuples de la requête <code>SELECT u.usename  ...</code></li>
</ul>
<p>Voir <a href="https://www.postgresql.org/docs/current/plpgsql.html">Documentation officielle</a></p>
<p>. . .</p>
<ul>
<li>Dans le corps de la boucle <code>LOOP</code>, on fabrique une requête :</li>
</ul>
<p><code>stmt := ...</code></p>
<ul>
<li>Puis on exécute cette requête :</li>
</ul>
<p><code>EXECUTE stmt INTO resp ;</code></p>
<p>. . .</p>
<p>Le résultat de la requête engendrée dynamiquement est affecté à la variable locale <code>stmt</code></p>
<p>Le contenu est accumulé dans <code>result</code></p>
<p>. . .</p>
<p>Renvoi du résultat</p>
<p><code>plpgSQL</code> propose une variété de manières de construire et de renvoyer le résultat d’une fonction</p>
<p>Voir <a href="https://www.postgresql.org/docs/current/plpgsql-declarations.html">Documentation officielle</a></p>
</section>
</section>
<section id="extension-de-sql-en-un-langage-procédural" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Extension de SQL en un langage procédural</h1>
<section id="extension-de-sql" class="level2">
<h2 class="anchored" data-anchor-id="extension-de-sql">Extension de SQL</h2>
<p>A travers ces deux exemples, on a vu quelques particularités des extensions possible de <code>SQL</code> en un langage procédural <code>pgplSQL</code>. Le principe est le même dans la plupart des SGBD permettant une telle extension (<code>Oracle</code>, <code>SQL Server</code>, …). Il repose sur la norme <code>SQL</code>.</p>
<p>On a besoin :</p>
<ul>
<li><p>d’instructions conditionnelles (<em>si … alors … sinon</em>)</p></li>
<li><p>d’instruction itératives (<em>boucles</em>)</p></li>
<li><p>de la capacité à définir des variables</p></li>
<li><p>de mécanismes d’articulations entre <code>SQL</code> et son extension procédurale :</p>
<ul>
<li>Pouvoir stocker le résultat d’une requête (avec résultat unique) dans une variable</li>
<li>Pouvoir stocker, les uns après les autres, les résultats d’une requêtes complexes pour traitement, définir un curseur (<code>CURSOR</code>)</li>
</ul></li>
</ul>
</section>
<section id="extension-de-sql-1" class="level2">
<h2 class="anchored" data-anchor-id="extension-de-sql-1">Extension de SQL</h2>
<p>On doit avoir un mécanisme qui permet conserver les programmes écrits pour les utiliser lors de sessions futures</p>
<p>Le langage <code>plpgsql</code> permet :</p>
<ul>
<li><p>de définir des fonctions et procédures stockées…</p></li>
<li><p>qui vont avoir la même <em>persistence</em> que les <em>tables</em>, <em>vues</em>, etc</p></li>
<li><p>L’existence de ces fonctions, leurs codes, etc, seront conservés dans des tables et vue d’administration (<code>information_schema.routines</code>).</p></li>
</ul>
</section>
<section id="exemple" class="level2">
<h2 class="anchored" data-anchor-id="exemple">Exemple</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> routine_catalog, routine_schema, routine_name, data_type, security_type</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> information_schema.routines    #<span class="op">&lt;&lt;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> routine_type<span class="op">=</span><span class="st">'FUNCTION'</span> <span class="kw">AND</span> specific_schema<span class="op">=</span><span class="st">'sakila'</span>   #<span class="op">&lt;&lt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>. . .</p>
<pre><code>routine_catalog|routine_schema|routine_name              |data_type   |security_type|
---------------+--------------+--------------------------+------------+-------------+
bd_2023        |sakila        |_group_concat             |text        |INVOKER      |
bd_2023        |sakila        |film_in_stock             |integer     |INVOKER      |
bd_2023        |sakila        |film_not_in_stock         |integer     |INVOKER      |
bd_2023        |sakila        |get_customer_balance      |numeric     |INVOKER      |
bd_2023        |sakila        |inventory_held_by_customer|integer     |INVOKER      |
bd_2023        |sakila        |inventory_in_stock        |boolean     |INVOKER      |
bd_2023        |sakila        |last_day                  |date        |INVOKER      |
bd_2023        |sakila        |last_updated              |trigger     |INVOKER      |
bd_2023        |sakila        |rewards_report            |USER-DEFINED|DEFINER      |</code></pre>
</section>
</section>
<section id="un-exemple-plus-complexe-issu-de-sakila" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Un exemple plus complexe issu de <code>sakila</code></h1>
<section id="rewards_report-signature" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="rewards_report-signature"><code>rewards_report</code> signature</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    sakila.rewards_report(min_monthly_purchases <span class="dt">integer</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                          min_dollar_amount_purchased <span class="dt">numeric</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a> RETURNS SETOF sakila.customer</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> LANGUAGE plpgsql</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a> SECURITY <span class="kw">DEFINER</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> $function$</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="dt">DATE</span>;</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    last_month_end <span class="dt">DATE</span>;</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>rr <span class="dt">RECORD</span>;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>tmpSQL TEXT;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> $$ ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Détermine la liste des bons clients qui beaucoup consommé durant le dernier mois écoulé</p>
<hr>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> sakila.rewards_report(min_monthly_purchases <span class="dt">integer</span>, min_dollar_amount_purchased <span class="dt">numeric</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a> RETURNS SETOF sakila.customer</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a> LANGUAGE plpgsql</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a> SECURITY <span class="kw">DEFINER</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> $function$</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="dt">DATE</span>;</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    last_month_end <span class="dt">DATE</span>;</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>rr <span class="dt">RECORD</span>;</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>tmpSQL TEXT;</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Some sanity checks... */</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> min_monthly_purchases <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">'Minimum monthly purchases parameter must be &gt; 0'</span>;</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> min_dollar_amount_purchased <span class="op">=</span> <span class="fl">0.00</span> <span class="cf">THEN</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">'Minimum monthly dollar amount purchased parameter must be &gt; $0.00'</span>;</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="op">:=</span> <span class="fu">CURRENT_DATE</span> <span class="op">-</span> <span class="st">'3 month'</span>:<span class="ch">:interval</span>;</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="op">:=</span> <span class="fu">to_date</span>((<span class="fu">extract</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> last_month_start) <span class="op">||</span> <span class="st">'-'</span> <span class="op">||</span> <span class="fu">extract</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> last_month_start) <span class="op">||</span> <span class="st">'-01'</span>),<span class="st">'YYYY-MM-DD'</span>);</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    last_month_end <span class="op">:=</span> <span class="fu">LAST_DAY</span>(last_month_start);</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporary storage area for Customer IDs.</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CREATE</span> <span class="kw">TEMPORARY</span> <span class="kw">TABLE</span> tmpCustomer (customer_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>);</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co">    Find all customers meeting the monthly purchase requirements</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    tmpSQL <span class="op">:=</span> <span class="st">'INSERT INTO tmpCustomer (customer_id)</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT p.customer_id</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM payment AS p</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE DATE(p.payment_date) BETWEEN '</span><span class="op">||</span>quote_literal(last_month_start) <span class="op">||</span><span class="st">' AND '</span><span class="op">||</span> quote_literal(last_month_end) <span class="op">||</span> <span class="st">'</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="st">        GROUP BY customer_id</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="st">        HAVING SUM(p.amount) &gt; '</span><span class="op">||</span> min_dollar_amount_purchased <span class="op">||</span> <span class="st">'</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="st">        AND COUNT(customer_id) &gt; '</span> <span class="op">||</span>min_monthly_purchases ;</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXECUTE</span> tmpSQL;</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Output ALL customer information of matching rewardees.</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="co">    Customize output as needed.</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> rr <span class="kw">IN</span> <span class="kw">EXECUTE</span> <span class="st">'SELECT c.* FROM tmpCustomer AS t INNER JOIN customer AS c ON t.customer_id = c.customer_id'</span> <span class="cf">LOOP</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">RETURN</span> <span class="kw">NEXT</span> rr;</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Clean up */</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    tmpSQL <span class="op">:=</span> <span class="st">'DROP TABLE tmpCustomer'</span>;</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXECUTE</span> tmpSQL;</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="kw">RETURN</span>;</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>$function$</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="co">-- Permissions</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">FUNCTION</span> sakila.rewards_report(int4, <span class="dt">numeric</span>) OWNER <span class="kw">TO</span> postgres;</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> sakila.rewards_report(int4, <span class="dt">numeric</span>) <span class="kw">TO</span> postgres;</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<blockquote class="blockquote">
<p>Whenever you create a new table, PostgreSQL automatically creates a composite type based on the structure of the table. This allows you to treat table rows as objects in their own right. You’ll appreciate this automatic type creation when you write functions that loop through tables. pgAdmin doesn’t make the automatic type creation obvious because it does not list them under the types node, but rest assured that they are there</p>
</blockquote>
<hr>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1"><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i></h2>
<ul>
<li>la signature comporte une déclaration de type originale</li>
<li>la déclaration des variables locales mentionne un type fourre-tout</li>
</ul>
<section id="setof-customer" class="level4">
<h4 class="anchored" data-anchor-id="setof-customer"><code>SETOF customer</code></h4>
<p>Table de même schéma que <code>customer</code> (mêmes colonnes)</p>
<p>Construction très très utile : <code>SETOF nom_de_table</code></p>
</section>
<section id="record" class="level4">
<h4 class="anchored" data-anchor-id="record"><code>RECORD</code></h4>
<p>Un type générique (fourre-tout) pour désigner les types <em>composés</em> (en particulier comme les types définis à partir des tables)</p>
<hr>
</section>
</section>
<section id="rewards_report-corps-i" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="rewards_report-corps-i"><code>rewards_report</code> corps (I)</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Some sanity checks... */</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> min_monthly_purchases <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">'Minimum monthly purchases parameter must be &gt; 0'</span>;</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> min_dollar_amount_purchased <span class="op">=</span> <span class="fl">0.00</span> <span class="cf">THEN</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">'Minimum monthly dollar amount purchased parameter must be &gt; $0.00'</span>;  #<span class="op">&lt;&lt;</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="op">:=</span> <span class="fu">CURRENT_DATE</span> <span class="op">-</span> <span class="st">'3 month'</span>:<span class="ch">:interval</span>;</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    last_month_start <span class="op">:=</span> <span class="fu">to_date</span>((<span class="fu">extract</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> last_month_start) <span class="op">||</span> <span class="st">'-'</span> <span class="op">||</span> <span class="fu">extract</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> last_month_start) <span class="op">||</span> <span class="st">'-01'</span>),<span class="st">'YYYY-MM-DD'</span>);</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    last_month_end <span class="op">:=</span> <span class="fu">LAST_DAY</span>(last_month_start);</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>. . .</p>
<p><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i> <code>RAISE EXCEPTION 'msg'</code></p>
<p>termine (en erreur) l’exécution de la fonction envoie un message d’erreur</p>
</section>
<section id="rewards_report-corps-ii" class="level2">
<h2 class="anchored" data-anchor-id="rewards_report-corps-ii"><code>rewards_report</code> corps (II)</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporary storage area for Customer IDs.</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CREATE</span> <span class="kw">TEMPORARY</span> <span class="kw">TABLE</span> tmpCustomer (customer_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>);</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Find all customers meeting the monthly purchase requirements</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    tmpSQL <span class="op">:=</span> <span class="st">'INSERT INTO tmpCustomer (customer_id)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT p.customer_id</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM payment AS p</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE DATE(p.payment_date) BETWEEN '</span><span class="op">||</span> quote_literal(last_month_start) <span class="op">||</span><span class="st">' AND '</span><span class="op">||</span> quote_literal(last_month_end) <span class="op">||</span> <span class="st">'</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="st">        GROUP BY customer_id</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="st">        HAVING SUM(p.amount) &gt; '</span> <span class="op">||</span> min_dollar_amount_purchased <span class="op">||</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'AND COUNT(customer_id) &gt; '</span> <span class="op">||</span> </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        min_monthly_purchases ;</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXECUTE</span> tmpSQL;  #<span class="op">&lt;&lt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-temporary-table-..." class="level2">
<h2 class="anchored" data-anchor-id="create-temporary-table-..."><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i> <code>CREATE TEMPORARY TABLE ...</code></h2>
<p>Crée une table (très simple ici) qui sera détruite avant la fin de l’exécution de la fonction.</p>
<p>Si l’exécution de la fonction devait être interrompue, cette table ne survivrait pas à la <em>session</em> qui a invoqué la fonction</p>
</section>
<section id="pourquoi-utiliser-une-requête-créée-dynamiquement" class="level2">
<h2 class="anchored" data-anchor-id="pourquoi-utiliser-une-requête-créée-dynamiquement">Pourquoi utiliser une requête créée dynamiquement ?</h2>
<ul>
<li><p>Est ce une nécessité ici ?</p></li>
<li><p>Si non, quel est l’intérêt ?</p></li>
</ul>
</section>
<section id="rewards_report-corps-iii" class="level2">
<h2 class="anchored" data-anchor-id="rewards_report-corps-iii"><code>rewards_report</code> corps III</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">    Output ALL customer information of matching rewardees.</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Customize output as needed.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> rr <span class="kw">IN</span> <span class="kw">EXECUTE</span> <span class="st">'SELECT c.* FROM tmpCustomer AS t INNER JOIN customer AS c ON t.customer_id = c.customer_id'</span> <span class="cf">LOOP</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">RETURN</span> <span class="kw">NEXT</span> rr;   #<span class="op">&lt;&lt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Clean up */</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    tmpSQL <span class="op">:=</span> <span class="st">'DROP TABLE tmpCustomer'</span>;</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXECUTE</span> tmpSQL;</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">RETURN</span>;   #<span class="op">&lt;&lt;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>$function$ ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<section id="for-rr-in-execute-..." class="level4">
<h4 class="anchored" data-anchor-id="for-rr-in-execute-..."><code>FOR rr IN EXECUTE ...</code></h4>
</section>
<section id="return-next-rr" class="level4">
<h4 class="anchored" data-anchor-id="return-next-rr"><code>RETURN NEXT rr</code></h4>
<hr>
<p><i class="fa-solid fa-hand-point-right" aria-label="hand-point-right"></i> Les requêtes dynamiques sont-elles vraiment nécessaires ?</p>
<hr>
</section>
</section>
</section>
<section id="fin" class="level1" data-background-color="#1c191c">
<h1 data-background-color="#1c191c">Fin</h1>


</section>

</main> <!-- /main -->

<script>
  // htmlwidgets need to know to resize themselves when slides are shown/hidden.
  // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
  // slide changes (different for each slide format).
  (function () {
    // dispatch for htmlwidgets
    function fireSlideEnter() {
      const event = window.document.createEvent("Event");
      event.initEvent("slideenter", true, true);
      window.document.dispatchEvent(event);
    }

    function fireSlideChanged(previousSlide, currentSlide) {
      fireSlideEnter();

      // dispatch for shiny
      if (window.jQuery) {
        if (previousSlide) {
          window.jQuery(previousSlide).trigger("hidden");
        }
        if (currentSlide) {
          window.jQuery(currentSlide).trigger("shown");
        }
      }
    }

    // hookup for slidy
    if (window.w3c_slidy) {
      window.w3c_slidy.add_observer(function (slide_num) {
        // slide_num starts at position 1
        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
      });
    }

  })();
</script>

<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/s-v-b\.github\.io\/MA15Y030\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Stéphane Boucheron</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/s-v-b/MA15Y030/edit/main/slides/SQL_5.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/s-v-b/MA15Y030/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with blood, sweat, tears, and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>